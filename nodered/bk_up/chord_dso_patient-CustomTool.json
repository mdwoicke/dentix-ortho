{
  "name": "chord_dso_patient",
  "description": "REQUIRED: Use this tool for ALL patient operations including creating patients, looking up existing patients, and getting clinic information.\n\nACTION 'create': Call to create a new patient record. Provide patientFirstName, patientLastName, phoneNumber, birthdayDateTime (MM/DD/YYYY), and emailAddress.\n\nACTION 'lookup': Call to search for existing patients by phone number or name.\n\nACTION 'get': Call to retrieve patient details by patientGUID.\n\nACTION 'clinic_info': Call to get list of clinic locations and their GUIDs.\n\nCRITICAL: You must create a patient (action 'create') before booking an appointment. Store the returned patientGUID for use with chord_dso_scheduling book_child action.\n",
  "color": "linear-gradient(rgb(145,232,194), rgb(251,139,159))",
  "iconSrc": "",
  "schema": "[{\"id\":0,\"property\":\"action\",\"type\":\"string\",\"description\":\"The operation to perform. Valid values: lookup, get, create, appointments, clinic_info, edit_insurance, confirm_appointment\",\"required\":true},{\"id\":1,\"property\":\"phoneNumber\",\"type\":\"string\",\"description\":\"Phone number for patient lookup\",\"required\":false},{\"id\":2,\"property\":\"filter\",\"type\":\"string\",\"description\":\"LastName, FirstName or Patient ID for lookup\",\"required\":false},{\"id\":3,\"property\":\"patientGUID\",\"type\":\"string\",\"description\":\"Patient GUID for get/appointments/edit_insurance actions\",\"required\":false},{\"id\":4,\"property\":\"patientFirstName\",\"type\":\"string\",\"description\":\"Patient first name for create action\",\"required\":false},{\"id\":5,\"property\":\"patientLastName\",\"type\":\"string\",\"description\":\"Patient last name for create action\",\"required\":false},{\"id\":6,\"property\":\"birthdayDateTime\",\"type\":\"string\",\"description\":\"Patient date of birth in MM/DD/YYYY format\",\"required\":false},{\"id\":7,\"property\":\"gender\",\"type\":\"string\",\"description\":\"Patient gender. Valid values: M, F\",\"required\":false},{\"id\":8,\"property\":\"emailAddress\",\"type\":\"string\",\"description\":\"Email address for patient account\",\"required\":false},{\"id\":9,\"property\":\"providerGUID\",\"type\":\"string\",\"description\":\"Provider GUID\",\"required\":false},{\"id\":10,\"property\":\"locationGUID\",\"type\":\"string\",\"description\":\"Location GUID for the practice\",\"required\":false},{\"id\":11,\"property\":\"insuranceProvider\",\"type\":\"string\",\"description\":\"Insurance provider name\",\"required\":false},{\"id\":12,\"property\":\"insuranceGroupId\",\"type\":\"string\",\"description\":\"Insurance group ID\",\"required\":false},{\"id\":13,\"property\":\"insuranceMemberId\",\"type\":\"string\",\"description\":\"Insurance member ID\",\"required\":false},{\"id\":14,\"property\":\"appointmentId\",\"type\":\"string\",\"description\":\"Appointment GUID for confirm_appointment action\",\"required\":false}]",
  "func": "/**\n * ============================================================================\n * CHORD PATIENT - Cloud9 Direct API Integration\n * ============================================================================\n * Calls Cloud9 XML APIs directly (no Node-RED intermediary)\n *\n * Actions:\n *   - lookup: Find patient by phone/name (GetPatientList + filter)\n *   - get: Get patient details (GetPatientInformation)\n *   - create: Create new patient (SetPatient)\n *   - appointments: Get patient appointments (GetAppointmentListByPatient)\n *   - clinic_info: Get locations (GetLocations)\n *   - edit_insurance: Write insurance to notes (SetPatientComment)\n *   - confirm_appointment: Confirm appointment (SetAppointmentStatusConfirmed)\n * ============================================================================\n */\n\nconst fetch = require('node-fetch');\n\n// ============================================================================\n// CLOUD9 API CONFIGURATION (Sandbox)\n// ============================================================================\n\nconst CLOUD9 = {\n    endpoint: 'https://us-ea1-partnertest.cloud9ortho.com/GetData.ashx',\n    clientId: 'c15aa02a-adc1-40ae-a2b5-d2e39173ae56',\n    userName: 'IntelepeerTest',\n    password: '#!InteleP33rTest!#',\n    namespace: 'http://schemas.practica.ws/cloud9/partners/',\n    vendorUserName: 'IntelepeerTest',\n    // Sandbox defaults (GetProviders returns empty in sandbox)\n    defaultProviderGUID: '79ec29fe-c315-4982-845a-0005baefb5a8',\n    defaultLocationGUID: '1070d281-0952-4f01-9a6e-1a2e6926a7db'\n};\n\n// ============================================================================\n// XML UTILITIES\n// ============================================================================\n\nfunction escapeXml(str) {\n    if (str === null || str === undefined) return '';\n    return String(str).replace(/[<>&'\"]/g, c => ({\n        '<': '&lt;', '>': '&gt;', '&': '&amp;', \"'\": '&apos;', '\"': '&quot;'\n    }[c]));\n}\n\nfunction buildXmlRequest(procedure, params = {}) {\n    const paramElements = Object.entries(params)\n        .filter(([_, v]) => v !== null && v !== undefined && v !== '')\n        .map(([k, v]) => `<${k}>${escapeXml(v)}</${k}>`)\n        .join('');\n    \n    return `<?xml version=\"1.0\" encoding=\"utf-8\"?><GetDataRequest xmlns=\"${CLOUD9.namespace}\" xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"><ClientID>${CLOUD9.clientId}</ClientID><UserName>${CLOUD9.userName}</UserName><Password>${escapeXml(CLOUD9.password)}</Password><Procedure>${procedure}</Procedure><Parameters>${paramElements}</Parameters></GetDataRequest>`;\n}\n\nfunction parseXmlResponse(xmlText) {\n    const statusMatch = xmlText.match(/<ResponseStatus>([^<]+)<\\/ResponseStatus>/);\n    const status = statusMatch ? statusMatch[1] : 'Unknown';\n    \n    if (status === 'Error' || status !== 'Success') {\n        const errorMatch = xmlText.match(/<Result>([^<]+)<\\/Result>/);\n        if (errorMatch && (errorMatch[1].includes('Error') || errorMatch[1].includes('error'))) {\n            throw new Error(errorMatch[1]);\n        }\n    }\n    \n    const records = [];\n    const recordRegex = /<Record>([\\s\\S]*?)<\\/Record>/g;\n    let match;\n    while ((match = recordRegex.exec(xmlText)) !== null) {\n        const record = {};\n        const fieldRegex = /<([A-Za-z0-9_]+)>([^<]*)<\\/\\1>/g;\n        let fieldMatch;\n        while ((fieldMatch = fieldRegex.exec(match[1])) !== null) {\n            record[fieldMatch[1]] = fieldMatch[2];\n        }\n        records.push(record);\n    }\n    return { status, records };\n}\n\n// ============================================================================\n// HELPER FUNCTIONS\n// ============================================================================\n\nfunction cleanParams(params) {\n    const cleaned = {};\n    for (const [key, value] of Object.entries(params)) {\n        if (value !== null && value !== undefined && value !== '' &&\n            value !== 'NULL' && value !== 'null' && value !== 'None' &&\n            value !== 'none' && value !== 'N/A' && value !== 'n/a') {\n            cleaned[key] = value;\n        }\n    }\n    return cleaned;\n}\n\nfunction formatBirthdayForCloud9(dateStr) {\n    if (!dateStr) return null;\n    const parts = dateStr.split('/');\n    if (parts.length !== 3) return dateStr;\n    return `${parts[2]}-${parts[0].padStart(2,'0')}-${parts[1].padStart(2,'0')}T00:00:00`;\n}\n\nfunction extractGuidFromResult(result, pattern) {\n    if (!result) return null;\n    const match = result.match(pattern);\n    return match ? match[1] : null;\n}\n\nasync function callCloud9(procedure, apiParams) {\n    const xmlRequest = buildXmlRequest(procedure, apiParams);\n    console.log(`[chord_patient] Calling Cloud9: ${procedure}`);\n    console.log(`[chord_patient] Endpoint: ${CLOUD9.endpoint}`);\n    \n    const response = await fetch(CLOUD9.endpoint, {\n        method: 'POST',\n        headers: { 'Content-Type': 'application/xml' },\n        body: xmlRequest,\n        timeout: 30000\n    });\n    \n    const xmlText = await response.text();\n    console.log(`[chord_patient] Response status: ${response.status}`);\n    \n    if (!response.ok) {\n        throw new Error(`HTTP ${response.status}: ${response.statusText}`);\n    }\n    \n    return parseXmlResponse(xmlText);\n}\n\n// ============================================================================\n// MAIN EXECUTION\n// ============================================================================\n\nasync function executeRequest() {\n    const toolName = 'chord_patient';\n    const action = $action;\n    \n    console.log(`[${toolName}] Action: ${action}`);\n    \n    const validActions = ['lookup', 'get', 'create', 'appointments', 'clinic_info', 'edit_insurance', 'confirm_appointment'];\n    if (!action || !validActions.includes(action)) {\n        throw new Error(`Invalid action '${action}'. Valid: ${validActions.join(', ')}`);\n    }\n    \n    const rawParams = {\n        phoneNumber: typeof $phoneNumber !== 'undefined' ? $phoneNumber : null,\n        filter: typeof $filter !== 'undefined' ? $filter : null,\n        patientGUID: typeof $patientGUID !== 'undefined' ? $patientGUID : null,\n        patientFirstName: typeof $patientFirstName !== 'undefined' ? $patientFirstName : null,\n        patientLastName: typeof $patientLastName !== 'undefined' ? $patientLastName : null,\n        birthdayDateTime: typeof $birthdayDateTime !== 'undefined' ? $birthdayDateTime : null,\n        gender: typeof $gender !== 'undefined' ? $gender : null,\n        emailAddress: typeof $emailAddress !== 'undefined' ? $emailAddress : null,\n        providerGUID: typeof $providerGUID !== 'undefined' ? $providerGUID : null,\n        locationGUID: typeof $locationGUID !== 'undefined' ? $locationGUID : null,\n        insuranceProvider: typeof $insuranceProvider !== 'undefined' ? $insuranceProvider : null,\n        insuranceGroupId: typeof $insuranceGroupId !== 'undefined' ? $insuranceGroupId : null,\n        insuranceMemberId: typeof $insuranceMemberId !== 'undefined' ? $insuranceMemberId : null,\n        appointmentId: typeof $appointmentId !== 'undefined' ? $appointmentId : null\n    };\n    const params = cleanParams(rawParams);\n    \n    try {\n        let result;\n        \n        switch (action) {\n            case 'lookup': {\n                if (!params.phoneNumber && !params.filter) {\n                    throw new Error('phoneNumber or filter required');\n                }\n                const apiParams = {};\n                if (params.locationGUID) apiParams.LocGUIDs = params.locationGUID;\n                \n                const parsed = await callCloud9('GetPatientList', apiParams);\n                \n                const searchPhone = params.phoneNumber ? params.phoneNumber.replace(/\\D/g, '') : null;\n                const searchName = params.filter ? params.filter.toLowerCase() : null;\n                \n                const filtered = parsed.records.filter(p => {\n                    const patPhone = (p.PhoneNumber || p.CellPhone || p.HomePhone || '').replace(/\\D/g, '');\n                    if (searchPhone && patPhone.includes(searchPhone)) return true;\n                    if (searchName) {\n                        const fullName = `${p.PatientLastName || ''}, ${p.PatientFirstName || ''}`.toLowerCase();\n                        const reverseName = `${p.PatientFirstName || ''} ${p.PatientLastName || ''}`.toLowerCase();\n                        return fullName.includes(searchName) || reverseName.includes(searchName);\n                    }\n                    return false;\n                });\n                \n                result = { patients: filtered, count: filtered.length };\n                console.log(`[${toolName}] Found ${filtered.length} matching patients`);\n                break;\n            }\n            \n            case 'get': {\n                if (!params.patientGUID) throw new Error('patientGUID required');\n                const parsed = await callCloud9('GetPatientInformation', { patguid: params.patientGUID });\n                result = { patient: parsed.records[0] || null };\n                console.log(`[${toolName}] Patient retrieved`);\n                break;\n            }\n            \n            case 'create': {\n                if (!params.patientFirstName) throw new Error('patientFirstName required');\n                if (!params.patientLastName) throw new Error('patientLastName required');\n                \n                // Use sandbox defaults if GUIDs not provided\n                const providerGUID = params.providerGUID || CLOUD9.defaultProviderGUID;\n                const locationGUID = params.locationGUID || CLOUD9.defaultLocationGUID;\n                console.log(`[chord_patient] Using providerGUID: ${providerGUID}`);\n                console.log(`[chord_patient] Using locationGUID: ${locationGUID}`);\n                \n                const apiParams = {\n                    patientFirstName: params.patientFirstName,\n                    patientLastName: params.patientLastName,\n                    providerGUID: providerGUID,\n                    locationGUID: locationGUID,\n                    VendorUserName: CLOUD9.vendorUserName\n                };\n                if (params.birthdayDateTime) apiParams.birthdayDateTime = formatBirthdayForCloud9(params.birthdayDateTime);\n                if (params.phoneNumber) apiParams.phoneNumber = params.phoneNumber;\n                if (params.emailAddress) apiParams.email = params.emailAddress;\n                if (params.gender) apiParams.gender = params.gender;\n                \n                const parsed = await callCloud9('SetPatient', apiParams);\n                const createResult = parsed.records[0]?.Result || '';\n                const patientGUID = extractGuidFromResult(createResult, /Patient Added:\\s*([A-Fa-f0-9-]+)/i);\n                \n                result = {\n                    success: createResult.includes('Added'),\n                    patientGUID: patientGUID,\n                    message: createResult\n                };\n                console.log(`[${toolName}] Patient created: ${patientGUID}`);\n                break;\n            }\n            \n            case 'appointments': {\n                if (!params.patientGUID) throw new Error('patientGUID required');\n                const parsed = await callCloud9('GetAppointmentListByPatient', { patGUID: params.patientGUID });\n                result = { appointments: parsed.records, count: parsed.records.length };\n                console.log(`[${toolName}] Found ${parsed.records.length} appointments`);\n                break;\n            }\n            \n            case 'clinic_info': {\n                const parsed = await callCloud9('GetLocations', {});\n                const locations = parsed.records;\n                \n                if (params.locationGUID) {\n                    const match = locations.find(l => \n                        l.LocationGUID && l.LocationGUID.toLowerCase() === params.locationGUID.toLowerCase()\n                    );\n                    if (match) {\n                        result = { success: true, location: match, matchType: 'guid' };\n                    }\n                }\n                \n                if (!result) {\n                    result = {\n                        success: true,\n                        locations: locations,\n                        count: locations.length,\n                        location: locations[0] || null\n                    };\n                }\n                console.log(`[${toolName}] Found ${locations.length} locations`);\n                break;\n            }\n            \n            case 'edit_insurance': {\n                if (!params.patientGUID) throw new Error('patientGUID required');\n                \n                const insuranceNote = [\n                    `=== Insurance Information ==`,\n                    `Provider: ${params.insuranceProvider || 'N/A'}`,\n                    `Group ID: ${params.insuranceGroupId || 'N/A'}`,\n                    `Member ID: ${params.insuranceMemberId || 'N/A'}`,\n                    `Updated: ${new Date().toISOString()}`\n                ].join('\\n');\n                \n                const parsed = await callCloud9('SetPatientComment', {\n                    patGUID: params.patientGUID,\n                    patComment: insuranceNote\n                });\n                \n                const updateResult = parsed.records[0]?.Result || 'Insurance info saved to notes';\n                result = {\n                    success: !updateResult.toLowerCase().includes('error'),\n                    message: updateResult\n                };\n                console.log(`[${toolName}] Insurance info written to notes`);\n                break;\n            }\n            \n            case 'confirm_appointment': {\n                if (!params.appointmentId) throw new Error('appointmentId required');\n                const parsed = await callCloud9('SetAppointmentStatusConfirmed', { apptGUID: params.appointmentId });\n                const confirmResult = parsed.records[0]?.Result || 'Appointment confirmed';\n                result = {\n                    success: !confirmResult.toLowerCase().includes('error'),\n                    message: confirmResult\n                };\n                console.log(`[${toolName}] Appointment confirmed`);\n                break;\n            }\n        }\n        \n        return JSON.stringify(result);\n        \n    } catch (error) {\n        console.error(`[${toolName}] Error:`, error.message);\n        return JSON.stringify({\n            error: `Failed to execute ${action}`,\n            message: error.message,\n            action: action,\n            timestamp: new Date().toISOString()\n        });\n    }\n}\n\nreturn executeRequest();\n",
  "workspaceId": "9e7c759d-2623-4529-945d-6c578631aad0"
}