{
  "name": "chord_dso_scheduling",
  "description": "Unified appointment scheduling tool. Use action 'slots' to get available appointment times, 'grouped_slots' for booking multiple patients together (e.g., siblings), 'book_child' to create an appointment using slot data from [$selected_appointment] for yourself, or 'cancel' to cancel an existing appointment.",
  "color": "linear-gradient(rgb(187,123,6), rgb(87,134,116))",
  "iconSrc": "",
  "schema": "[{\"id\":0,\"property\":\"action\",\"type\":\"string\",\"description\":\"The scheduling operation to perform. Valid values: slots, grouped_slots, book_child, cancel\",\"required\":true},{\"id\":1,\"property\":\"startDate\",\"type\":\"string\",\"description\":\"Start date for slot search in MM/DD/YYYY format\",\"required\":false},{\"id\":2,\"property\":\"endDate\",\"type\":\"string\",\"description\":\"End date for slot search in MM/DD/YYYY format\",\"required\":false},{\"id\":3,\"property\":\"scheduleViewGUIDs\",\"type\":\"string\",\"description\":\"Comma-separated schedule view GUIDs to search\",\"required\":false},{\"id\":4,\"property\":\"numberOfPatients\",\"type\":\"integer\",\"description\":\"Number of patients for grouped_slots action\",\"required\":false},{\"id\":5,\"property\":\"timeWindowMinutes\",\"type\":\"integer\",\"description\":\"Time window in minutes for grouped_slots (30 for 1-2 children, 45 for 3+)\",\"required\":false},{\"id\":6,\"property\":\"patientGUID\",\"type\":\"string\",\"description\":\"Patient GUID for book_child action\",\"required\":false},{\"id\":7,\"property\":\"startTime\",\"type\":\"string\",\"description\":\"Appointment start time in MM/DD/YYYY HH:MM AM format\",\"required\":false},{\"id\":8,\"property\":\"scheduleViewGUID\",\"type\":\"string\",\"description\":\"Schedule view GUID for booking\",\"required\":false},{\"id\":9,\"property\":\"scheduleColumnGUID\",\"type\":\"string\",\"description\":\"Schedule column GUID for booking\",\"required\":false},{\"id\":10,\"property\":\"appointmentTypeGUID\",\"type\":\"string\",\"description\":\"Appointment type GUID for booking\",\"required\":false},{\"id\":11,\"property\":\"minutes\",\"type\":\"integer\",\"description\":\"Appointment duration in minutes\",\"required\":false},{\"id\":12,\"property\":\"providerGUID\",\"type\":\"string\",\"description\":\"Provider GUID for booking\",\"required\":false},{\"id\":13,\"property\":\"locationGUID\",\"type\":\"string\",\"description\":\"Location GUID for booking\",\"required\":false},{\"id\":14,\"property\":\"appointmentGUID\",\"type\":\"string\",\"description\":\"Appointment GUID for cancel action\",\"required\":false}]",
  "func": "/**\n * ============================================================================\n * CHORD SCHEDULING - Cloud9 Appointment Scheduling Tool\n * ============================================================================\n * Consolidates: getApptSlots, getGroupedApptSlots, createChildAppt, cancelAppt\n *\n * Actions:\n *   - slots: Get available appointment slots\n *   - grouped_slots: Get slots for multiple patients booking together (siblings)\n *   - book_child: Create/book appointment for a child patient\n *   - cancel: Cancel an existing appointment\n * ============================================================================\n */\n\nconst fetch = require('node-fetch');\n\n// ============================================================================\n// ðŸ“ ACTION CONFIGURATIONS\n// ============================================================================\n\nconst NODE_RED_URL ='https://c1-aicoe-nodered-lb.prod.c1conversations.io/FabricWorkflow/api';\n\nconst ACTIONS = {\n    slots: {\n        endpoint: `${NODE_RED_URL}/chord/cloud9-ortho/getApptSlots`,\n        method: 'POST',\n        buildBody: (params) => ({\n            startDate: params.startDate,\n            endDate: params.endDate,\n            scheduleViewGUIDs: params.scheduleViewGUIDs\n        }),\n        validate: (params) => {\n            if (!params.startDate) throw new Error(\"startDate is required for 'slots' action (format: MM/DD/YYYY)\");\n            if (!params.endDate) throw new Error(\"endDate is required for 'slots' action (format: MM/DD/YYYY)\");\n        },\n        successLog: (data) => `Found ${data.slots ? data.slots.length : 0} available slots`\n    },\n    grouped_slots: {\n        endpoint: `${NODE_RED_URL}/chord/cloud9-ortho/getGroupedApptSlots`,\n        method: 'POST',\n        buildBody: (params) => ({\n            startDate: params.startDate,\n            endDate: params.endDate,\n            scheduleViewGUIDs: params.scheduleViewGUIDs,\n            numberOfPatients: params.numberOfPatients,\n            appointmentDuration: params.timeWindowMinutes || (params.numberOfPatients >= 3 ? 45 : 30)\n        }),\n        validate: (params) => {\n            if (!params.startDate) throw new Error(\"startDate is required for 'grouped_slots' action (format: MM/DD/YYYY)\");\n            if (!params.endDate) throw new Error(\"endDate is required for 'grouped_slots' action (format: MM/DD/YYYY)\");\n            if (!params.numberOfPatients) throw new Error(\"numberOfPatients is required for 'grouped_slots' action\");\n        },\n        successLog: (data) => `Found ${data.slots ? data.slots.length : 0} grouped slot options for ${data.groupingInfo?.numberOfPatients || 'multiple'} patients`\n    },\n    book_child: {\n        endpoint: `${NODE_RED_URL}/chord/cloud9-ortho/createChildAppt`,\n        method: 'POST',\n        buildBody: (params) => ({\n            patientGUID: params.patientGUID,\n            startTime: params.startTime,\n            scheduleViewGUID: params.scheduleViewGUID,\n            scheduleColumnGUID: params.scheduleColumnGUID,\n            appointmentTypeGUID: params.appointmentTypeGUID,\n            minutes: params.minutes || 30,\n            providerGUID: params.providerGUID,\n            locationGUID: params.locationGUID\n        }),\n        validate: (params) => {\n            if (!params.patientGUID) throw new Error(\"patientGUID is required for 'book_child' action\");\n            if (!params.startTime) throw new Error(\"startTime is required for 'book_child' action (format: MM/DD/YYYY HH:MM AM)\");\n            if (!params.scheduleViewGUID) throw new Error(\"scheduleViewGUID is required for 'book_child' action\");\n            if (!params.scheduleColumnGUID) throw new Error(\"scheduleColumnGUID is required for 'book_child' action\");\n            if (!params.appointmentTypeGUID) throw new Error(\"appointmentTypeGUID is required for 'book_child' action\");\n        },\n        successLog: (data) => `Child appointment booked successfully${data.appointmentGUID ? ` (GUID: ${data.appointmentGUID})` : ''}`\n    },\n    cancel: {\n        endpoint: `${NODE_RED_URL}/chord/cloud9-ortho/cancelAppt`,\n        method: 'POST',\n        buildBody: (params) => ({\n            appointmentGUID: params.appointmentGUID,\n            cancellationReason: params.cancellationReason || 'Cancelled by IVA'\n        }),\n        validate: (params) => {\n            if (!params.appointmentGUID) {\n                throw new Error(\"appointmentGUID is required for 'cancel' action\");\n            }\n        },\n        successLog: () => 'Appointment cancellation requested'\n    }\n};\n\n// ============================================================================\n// ðŸ” AUTHENTICATION\n// ============================================================================\n\nfunction getAuthHeader() {\n    try {\n        const username = process.env.NODE_RED_USERNAME || \"workflowapi\";\n        const password = process.env.NODE_RED_PASSWORD || \"e^@V95&6sAJReTsb5!iq39mIC4HYIV\";\n        if (username && password) {\n            const credentials = Buffer.from(`${username}:${password}`).toString('base64');\n            return `Basic ${credentials}`;\n        }\n    } catch (e) {\n        return null;\n    }\n    return null;\n}\n\n// ============================================================================\n// ðŸ§¹ NULL VALUE FILTER - Removes null/undefined/empty values\n// ============================================================================\n\nfunction cleanParams(params) {\n    const cleaned = {};\n    for (const [key, value] of Object.entries(params)) {\n        if (value !== null &&\n            value !== undefined &&\n            value !== '' &&\n            value !== 'NULL' &&\n            value !== 'null' &&\n            value !== 'None' &&\n            value !== 'none' &&\n            value !== 'N/A' &&\n            value !== 'n/a') {\n            cleaned[key] = value;\n        }\n    }\n    return cleaned;\n}\n\n// ============================================================================\n// ðŸ” ERROR DETECTION HELPER\n// ============================================================================\n\nfunction checkForError(data) {\n    if (!data || typeof data !== 'object') return null;\n\n    // Pattern 1: { success: false, error: \"...\" }\n    if (data.success === false) {\n        return data.error || data.message || 'Operation failed';\n    }\n\n    // Pattern 2: { code: false, error: [...] }\n    if (data.code === false) {\n        if (Array.isArray(data.error)) {\n            return data.error.join(', ');\n        }\n        return data.error || data.message || 'API returned error';\n    }\n\n    // Pattern 3: String response containing error message\n    if (typeof data === 'string' && data.toLowerCase().includes('failed')) {\n        return data;\n    }\n\n    // Pattern 4: { error: \"...\" } without success/code field (but not valid response with data)\n    if (data.error && !data.data && !data.id && !data.slots && !data.groups && !data.appointments && !data.appointmentGUID) {\n        if (Array.isArray(data.error)) {\n            return data.error.join(', ');\n        }\n        return data.error;\n    }\n\n    return null;\n}\n\n// ============================================================================\n// ðŸš€ HTTP REQUEST ENGINE\n// ============================================================================\n\nasync function executeRequest() {\n    const toolName = 'chord_scheduling';\n    const action = $action;\n    const timeout = 30000;\n\n    console.log(`[${toolName}] Action: ${action}`);\n\n    // Validate action\n    if (!action || !ACTIONS[action]) {\n        const validActions = Object.keys(ACTIONS).join(', ');\n        throw new Error(`Invalid action '${action}'. Valid actions: ${validActions}`);\n    }\n\n    const config = ACTIONS[action];\n\n    // Build params object from Flowise variables\n    const rawParams = {\n        // Slot search parameters\n        startDate: typeof $startDate !== 'undefined' ? $startDate : null,\n        endDate: typeof $endDate !== 'undefined' ? $endDate : null,\n        scheduleViewGUIDs: typeof $scheduleViewGUIDs !== 'undefined' ? $scheduleViewGUIDs : null,\n        // Grouped slots parameters\n        numberOfPatients: typeof $numberOfPatients !== 'undefined' ? $numberOfPatients : null,\n        timeWindowMinutes: typeof $timeWindowMinutes !== 'undefined' ? $timeWindowMinutes : null,\n        // Booking parameters\n        patientGUID: typeof $patientGUID !== 'undefined' ? $patientGUID : null,\n        startTime: typeof $startTime !== 'undefined' ? $startTime : null,\n        scheduleViewGUID: typeof $scheduleViewGUID !== 'undefined' ? $scheduleViewGUID : null,\n        scheduleColumnGUID: typeof $scheduleColumnGUID !== 'undefined' ? $scheduleColumnGUID : null,\n        appointmentTypeGUID: typeof $appointmentTypeGUID !== 'undefined' ? $appointmentTypeGUID : null,\n        minutes: typeof $minutes !== 'undefined' ? $minutes : null,\n        providerGUID: typeof $providerGUID !== 'undefined' ? $providerGUID : null,\n        locationGUID: typeof $locationGUID !== 'undefined' ? $locationGUID : null,\n        // Cancel parameters\n        appointmentGUID: typeof $appointmentGUID !== 'undefined' ? $appointmentGUID : null,\n        cancellationReason: typeof $cancellationReason !== 'undefined' ? $cancellationReason : null\n    };\n\n    // Filter out null/undefined/empty values\n    const params = cleanParams(rawParams);\n\n    try {\n        // Validate required params for this action\n        config.validate(params);\n\n        // Build request body and clean it\n        const rawBody = config.buildBody(params);\n        const body = cleanParams(rawBody);\n\n        console.log(`[${toolName}] Endpoint: ${config.method} ${config.endpoint}`);\n        console.log(`[${toolName}] Request Body:`, JSON.stringify(body, null, 2));\n\n        const headers = {\n            'Content-Type': 'application/json'\n        };\n\n        const authHeader = getAuthHeader();\n        if (authHeader) {\n            headers['Authorization'] = authHeader;\n        }\n\n        const options = {\n            method: config.method,\n            headers: headers,\n            body: JSON.stringify(body)\n        };\n\n        // Add timeout\n        let timeoutId;\n        if (typeof AbortController !== 'undefined') {\n            const controller = new AbortController();\n            timeoutId = setTimeout(() => controller.abort(), timeout);\n            options.signal = controller.signal;\n        }\n\n        console.log(`[${toolName}] Making request...`);\n        const response = await fetch(config.endpoint, options);\n\n        if (timeoutId) clearTimeout(timeoutId);\n\n        console.log(`[${toolName}] Response Status: ${response.status} ${response.statusText}`);\n\n        let data;\n        const contentType = response.headers.get('content-type');\n        if (contentType && contentType.includes('application/json')) {\n            data = await response.json();\n        } else {\n            data = await response.text();\n        }\n\n        // Check HTTP status\n        if (!response.ok) {\n            console.error(`[${toolName}] HTTP Error ${response.status}:`, data);\n            let errorMsg = `HTTP ${response.status}: ${response.statusText}`;\n            if (data) {\n                const bodyError = checkForError(typeof data === 'string' ? (() => { try { return JSON.parse(data); } catch(e) { return data; } })() : data);\n                if (bodyError) errorMsg = bodyError;\n            }\n            throw new Error(errorMsg);\n        }\n\n        // Parse response if string\n        let responseData = data;\n        if (typeof data === 'string') {\n            try { responseData = JSON.parse(data); } catch (e) { responseData = data; }\n        }\n\n        // Check for error patterns in successful HTTP response\n        const errorMessage = checkForError(responseData);\n        if (errorMessage) {\n            console.error(`[${toolName}] API Error:`, responseData);\n            throw new Error(errorMessage);\n        }\n\n        // Dynamic success logging\n        const successMsg = typeof config.successLog === 'function' ? config.successLog(responseData) : config.successLog;\n        console.log(`[${toolName}] ${successMsg}`);\n\n        return JSON.stringify(responseData);\n\n    } catch (error) {\n        console.error(`[${toolName}] Error:`, error.message);\n\n        if (error.name === 'AbortError') {\n            error.message = `Request timeout after ${timeout}ms`;\n        }\n\n        const errorResponse = {\n            error: `Failed to execute ${action}`,\n            message: error.message,\n            action: action,\n            timestamp: new Date().toISOString()\n        };\n\n        return JSON.stringify(errorResponse);\n    }\n}\n\nreturn executeRequest();\n",
  "workspaceId": "9e7c759d-2623-4529-945d-6c578631aad0"
}