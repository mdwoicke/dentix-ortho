{
  "name": "chord_patient_v03",
  "description": "Unified patient and clinic tool. Use action 'lookup' to find patient by phone number, 'get' to retrieve patient by ID, 'create' to register a new patient, 'appointments' to get patient's scheduled appointments, 'clinic_info' to get clinic details like name and address, 'edit_insurance' to change an existing patient's insurance provider, or 'confirm_appointment' to confirm a patient's appointment by appointmentId.",
  "color": "linear-gradient(rgb(98,148,43), rgb(8,77,187))",
  "iconSrc": "",
  "schema": "[{\"id\":0,\"property\":\"action\",\"description\":\"The operation to perform: 'lookup' (find by phone), 'get' (by patientId), 'create' (register new patient), 'appointments' (get patient appts), 'clinic_info' (get clinic details), 'edit_insurance' (for changing a patient's insurance), 'confirm_appointment' (confirm an appointment)\",\"type\":\"string\",\"required\":true},{\"id\":1,\"property\":\"phoneNumber\",\"description\":\"Patient phone number. Required for 'lookup' and 'create' actions.\",\"type\":\"string\",\"required\":false},{\"id\":2,\"property\":\"patientId\",\"description\":\"Patient ID. Required for 'get' and 'appointments' actions.\",\"type\":\"string\",\"required\":false},{\"id\":3,\"property\":\"firstName\",\"description\":\"Patient first name. Required for 'create' action.\",\"type\":\"string\",\"required\":false},{\"id\":4,\"property\":\"lastName\",\"description\":\"Patient last name. Required for 'create' action.\",\"type\":\"string\",\"required\":false},{\"id\":5,\"property\":\"birthDate\",\"description\":\"Patient date of birth. Required for 'create' action.\",\"type\":\"string\",\"required\":false},{\"id\":6,\"property\":\"emailAddress\",\"description\":\"Patient email address. Required for 'create' action.\",\"type\":\"string\",\"required\":false},{\"id\":7,\"property\":\"insurance\",\"description\":\"Patient insurance provider. Optional for 'create' action.\",\"type\":\"string\",\"required\":false},{\"id\":8,\"property\":\"appointmentId\",\"description\":\"Appointment ID. Required for 'confirm_appointment' action.\",\"type\":\"string\",\"required\":false}]",
  "func": "/**\n * ============================================================================\n * CHORD PATIENT - Unified Patient & Clinic Tool\n * ============================================================================\n * Consolidates: getPatientByPhoneNumber, getPatient, createPatient, \n *               getPatientAppts, getLocation, editInsurance\n * \n * Actions:\n *   - lookup: Find patient by phone number\n *   - get: Get patient by ID\n *   - create: Register new patient\n *   - appointments: Get patient's appointments\n *   - clinic_info: Get clinic location details\n *   - edit_insurance: Update patient's insurance information\n * ============================================================================\n */\n\nconst fetch = require('node-fetch');\n\n// ============================================================================\n// ðŸ“ ACTION CONFIGURATIONS\n// ============================================================================\n\nconst BASE_URL = 'https://c1-aicoe-nodered-lb.prod.c1conversations.io/FabricWorkflow/api/chord';\n\nconst ACTIONS = {\n    lookup: {\n        endpoint: `${BASE_URL}/getPatientByPhoneNum`,\n        method: 'POST',\n        buildBody: (params, uui) => ({\n            uui: uui,\n            phoneNumber: params.phoneNumber\n        }),\n        validate: (params) => {\n            if (!params.phoneNumber) {\n                throw new Error(\"phoneNumber is required for 'lookup' action\");\n            }\n        },\n        successLog: 'Patient lookup completed'\n    },\n    get: {\n        endpoint: `${BASE_URL}/getPatient`,\n        method: 'POST',\n        buildBody: (params, uui) => ({\n            patientId: params.patientId,\n            locationId: params.locationId,\n            subdomain: params.subdomain,\n            phoneNum: params.phoneNumber\n        }),\n        validate: (params) => {\n            if (!params.patientId) {\n                throw new Error(\"patientId is required for 'get' action\");\n            }\n        },\n        successLog: 'Patient retrieved successfully'\n    },\n    create: {\n        endpoint: `${BASE_URL}/createPatient`,\n        method: 'POST',\n        buildBody: (params, uui) => {\n            const body = {\n                uui: uui,\n                firstName: params.firstName,\n                lastName: params.lastName\n            };\n            if (params.emailAddress) body.emailAddress = params.emailAddress;\n            if (params.phoneNumber) body.phoneNumber = params.phoneNumber;\n            if (params.birthDate) body.birthDate = params.birthDate;\n            if (params.insurance) body.insurance = params.insurance;\n            return body;\n        },\n        validate: (params) => {\n            if (!params.firstName) throw new Error(\"firstName is required for 'create' action\");\n            if (!params.lastName) throw new Error(\"lastName is required for 'create' action\");\n            if (!params.birthDate) throw new Error(\"birthDate is required for 'create' action\");\n            if (!params.phoneNumber) throw new Error(\"phoneNumber is required for 'create' action\");\n            if (!params.emailAddress) throw new Error(\"emailAddress is required for 'create' action\");\n        },\n        successLog: 'Patient created successfully'\n    },\n    appointments: {\n        endpoint: `${BASE_URL}/getPatientAppts`,\n        method: 'POST',\n        buildBody: (params, uui) => ({\n            uui: uui,\n            patientId: params.patientId\n        }),\n        validate: (params) => {\n            if (!params.patientId) {\n                throw new Error(\"patientId is required for 'appointments' action\");\n            }\n        },\n        successLog: 'Patient appointments retrieved'\n    },\n    clinic_info: {\n        endpoint: `${BASE_URL}/getLocation`,\n        method: 'POST',\n        buildBody: (params, uui) => ({\n            uui: uui\n        }),\n        validate: () => {},\n        successLog: 'Clinic info retrieved'\n    },\n    edit_insurance: {\n        endpoint: `${BASE_URL}/editInsurance`,\n        method: 'POST',\n        buildBody: (params, uui) => ({\n            uui: uui,\n            patientId: params.patientId,\n            insuranceName: params.insurance\n        }),\n        validate: (params) => {\n            if (!params.patientId) {\n                throw new Error(\"patientId is required for 'edit_insurance' action\");\n            }\n            if (!params.insuranceName) {\n                throw new Error(\"insuranceName is required for 'edit_insurance' action\");\n            }\n        },\n        successLog: 'Patient insurance updated successfully'\n    },\n    confirm_appointment: {\n        endpoint: `${BASE_URL}/confirmAppt`,\n        method: 'POST',\n        buildBody: (params, uui) => ({\n            uui: uui,\n            appointmentId: params.appointmentId\n        }),\n        validate: (params) => {\n            if (!params.appointmentId) {\n                throw new Error(\"appointmentId is required for 'confirm_appointment' action\");\n            }\n        },\n        successLog: 'Appointment confirmed successfully'\n    }\n};\n\n// ============================================================================\n// ðŸ” AUTHENTICATION\n// ============================================================================\n\nfunction getAuthHeader() {\n    try {\n        const username = \"workflowapi\";\n        const password = \"e^@V95&6sAJReTsb5!iq39mIC4HYIV\";\n        if (username && password) {\n            const credentials = Buffer.from(`${username}:${password}`).toString('base64');\n            return `Basic ${credentials}`;\n        }\n    } catch (e) {\n        return null;\n    }\n    return null;\n}\n\n// ============================================================================\n// ðŸ” ERROR DETECTION HELPER\n// ============================================================================\n\nfunction checkForError(data) {\n    if (!data || typeof data !== 'object') return null;\n    \n    // Check for various error patterns from backend\n    // Pattern 1: { success: false, error: \"...\" }\n    if (data.success === false) {\n        return data.error || data.message || 'Operation failed';\n    }\n    \n    // Pattern 2: { code: false, error: [...] } - Nexhealth API pattern\n    if (data.code === false) {\n        if (Array.isArray(data.error)) {\n            return data.error.join(', ');\n        }\n        return data.error || data.message || 'API returned error';\n    }\n    \n    // Pattern 3: String response containing error message\n    if (typeof data === 'string' && data.toLowerCase().includes('failed')) {\n        return data;\n    }\n    \n    // Pattern 4: { error: \"...\" } without success/code field\n    if (data.error && !data.data && !data.id) {\n        if (Array.isArray(data.error)) {\n            return data.error.join(', ');\n        }\n        return data.error;\n    }\n    \n    return null;\n}\n\n// ============================================================================\n// ðŸš€ HTTP REQUEST ENGINE\n// ============================================================================\n\nasync function executeRequest() {\n    const toolName = 'chord_patient';\n    const action = $action;\n    const timeout = 30000;\n    \n    console.log(`[${toolName}] Action: ${action}`);\n    \n    // Validate action\n    if (!action || !ACTIONS[action]) {\n        const validActions = Object.keys(ACTIONS).join(', ');\n        throw new Error(`Invalid action '${action}'. Valid actions: ${validActions}`);\n    }\n    \n    const config = ACTIONS[action];\n    \n    // Get UUI with fallback\n    let uui;\n    if (!$vars || !$vars.c1mg_uui || $vars.c1mg_uui === 'c1mg_uui' || (typeof $vars.c1mg_uui === 'string' && $vars.c1mg_uui.trim() === '')) {\n        uui = '765381306-000000000001030525-SR-000-000000000000DAL130-026DE427|333725|421458314VO|2d411063-3769-4618-86d1-925d3578c112|FSV';\n    } else {\n        uui = $vars.c1mg_uui;\n    }\n    \n    // Build params object from Flowise variables\n    const params = {\n        phoneNumber: typeof $phoneNumber !== 'undefined' ? $phoneNumber : null,\n        patientId: typeof $patientId !== 'undefined' ? $patientId : null,\n        firstName: typeof $firstName !== 'undefined' ? $firstName : null,\n        lastName: typeof $lastName !== 'undefined' ? $lastName : null,\n        birthDate: typeof $birthDate !== 'undefined' ? $birthDate : null,\n        emailAddress: typeof $emailAddress !== 'undefined' ? $emailAddress : null,\n        insurance: typeof $insurance !== 'undefined' ? $insurance : null,\n        insuranceName: typeof $insuranceName !== 'undefined' ? $insuranceName : null,\n        locationId: typeof $locationId !== 'undefined' ? $locationId : null,\n        subdomain: typeof $subdomain !== 'undefined' ? $subdomain : null,\n        appointmentId: typeof $appointmentId !== 'undefined' ? $appointmentId : null\n    };\n    \n    try {\n        // Validate required params for this action\n        config.validate(params);\n        \n        const body = config.buildBody(params, uui);\n        console.log(`[${toolName}] Endpoint: ${config.method} ${config.endpoint}`);\n        console.log(`[${toolName}] Request Body:`, JSON.stringify(body, null, 2));\n        \n        const headers = {\n            'Content-Type': 'application/json'\n        };\n        \n        const authHeader = getAuthHeader();\n        if (authHeader) {\n            headers['Authorization'] = authHeader;\n        }\n        \n        const options = {\n            method: config.method,\n            headers: headers,\n            body: JSON.stringify(body)\n        };\n        \n        // Add timeout\n        let timeoutId;\n        if (typeof AbortController !== 'undefined') {\n            const controller = new AbortController();\n            timeoutId = setTimeout(() => controller.abort(), timeout);\n            options.signal = controller.signal;\n        }\n        \n        console.log(`[${toolName}] Making request...`);\n        const response = await fetch(config.endpoint, options);\n        \n        if (timeoutId) clearTimeout(timeoutId);\n        \n        console.log(`[${toolName}] Response Status: ${response.status} ${response.statusText}`);\n        \n        let data;\n        const contentType = response.headers.get('content-type');\n        if (contentType && contentType.includes('application/json')) {\n            data = await response.json();\n        } else {\n            data = await response.text();\n        }\n        \n        // Check HTTP status\n        if (!response.ok) {\n            console.error(`[${toolName}] HTTP Error ${response.status}:`, data);\n            // Try to extract error message from response body\n            let errorMsg = `HTTP ${response.status}: ${response.statusText}`;\n            if (data) {\n                const bodyError = checkForError(typeof data === 'string' ? (() => { try { return JSON.parse(data); } catch(e) { return data; } })() : data);\n                if (bodyError) errorMsg = bodyError;\n            }\n            throw new Error(errorMsg);\n        }\n        \n        // Parse response if string\n        let responseData = data;\n        if (typeof data === 'string') {\n            try { responseData = JSON.parse(data); } catch (e) { responseData = data; }\n        }\n        \n        // Check for error patterns in successful HTTP response\n        const errorMessage = checkForError(responseData);\n        if (errorMessage) {\n            console.error(`[${toolName}] API Error:`, responseData);\n            throw new Error(errorMessage);\n        }\n        \n        console.log(`[${toolName}] ${config.successLog}`);\n        return JSON.stringify(responseData);\n        \n    } catch (error) {\n        console.error(`[${toolName}] Error:`, error.message);\n        \n        if (error.name === 'AbortError') {\n            error.message = `Request timeout after ${timeout}ms`;\n        }\n        \n        const errorResponse = {\n            error: `Failed to execute ${action}`,\n            message: error.message,\n            action: action,\n            timestamp: new Date().toISOString()\n        };\n        \n        throw new Error(JSON.stringify(errorResponse, null, 2));\n    }\n}\n\nreturn executeRequest();\n",
  "workspaceId": "9e7c759d-2623-4529-945d-6c578631aad0"
}