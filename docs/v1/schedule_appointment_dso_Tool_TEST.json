{
  "name": "schedule_appointment_ortho",
  "description": "Appointment scheduling tool for TEST/Sandbox environment. Use action 'slots' to find available appointment times, 'book_child' to book an appointment for a patient, or 'cancel' to cancel an existing appointment.",
  "color": "linear-gradient(rgb(58,159,203), rgb(65,135,54))",
  "iconSrc": "",
  "schema": "[{\"id\":0,\"property\":\"action\",\"type\":\"string\",\"description\":\"The operation to perform. Valid values: slots, book_child, cancel\",\"required\":true},{\"id\":1,\"property\":\"startDate\",\"type\":\"string\",\"description\":\"Start date for slot search in MM/DD/YYYY format\",\"required\":false},{\"id\":2,\"property\":\"endDate\",\"type\":\"string\",\"description\":\"End date for slot search in MM/DD/YYYY format\",\"required\":false},{\"id\":3,\"property\":\"patientGUID\",\"type\":\"string\",\"description\":\"Patient GUID for booking\",\"required\":false},{\"id\":4,\"property\":\"startTime\",\"type\":\"string\",\"description\":\"Appointment start time for booking\",\"required\":false},{\"id\":5,\"property\":\"scheduleViewGUID\",\"type\":\"string\",\"description\":\"Schedule view GUID for booking\",\"required\":false},{\"id\":6,\"property\":\"scheduleColumnGUID\",\"type\":\"string\",\"description\":\"Schedule column GUID for booking\",\"required\":false},{\"id\":7,\"property\":\"appointmentTypeGUID\",\"type\":\"string\",\"description\":\"Appointment type GUID\",\"required\":false},{\"id\":8,\"property\":\"minutes\",\"type\":\"number\",\"description\":\"Appointment duration in minutes\",\"required\":false},{\"id\":9,\"property\":\"appointmentGUID\",\"type\":\"string\",\"description\":\"Appointment GUID for cancellation\",\"required\":false},{\"id\":10,\"property\":\"childName\",\"type\":\"string\",\"description\":\"Child name for booking\",\"required\":false}]",
  "func": "/**\n * ============================================================================\n * CHORD SCHEDULING DSO - Appointment Scheduling Tool (TEST Cloud9 Direct)\n * Version: v53-TEST | Updated: 2026-01-13\n * ============================================================================\n * Actions: slots, book_child, cancel\n * \n * This version calls Cloud9 TEST SANDBOX directly via XML/SOAP.\n * For Sandbox A testing only - NOT for production.\n * ============================================================================\n */\n\nconst https = require('https');\n\nconst TOOL_VERSION = 'v53-TEST';\nconst MAX_SLOTS_RETURNED = 3;\n\n// ============================================================================\n// TEST CLOUD9 CONFIGURATION\n// ============================================================================\n\nconst CLOUD9_CONFIG = {\n    hostname: 'us-ea1-partnertest.cloud9ortho.com',\n    path: '/GetData.ashx',\n    clientId: 'c15aa02a-adc1-40ae-a2b5-d2e39173ae56',\n    userName: 'IntelepeerTest',\n    password: '#!InteleP33rTest!#'\n};\n\n// Default GUIDs for TEST environment (Location14 - verified working in Postman)\nconst DEFAULT_LOCATION_GUID = '1070d281-0952-4f01-9a6e-1a2e6926a7db';  // Location14\nconst DEFAULT_SCHEDULE_VIEW_GUID = '2544683a-8e79-4b32-a4d4-bf851996bac3';  // Location14\nconst DEFAULT_SCHEDULE_COLUMN_GUID = 'e062b81f-1fff-40fc-b4a4-1cf9ecc2f32b';  // TC 1\nconst DEFAULT_APPT_TYPE_GUID = '8fc9d063-ae46-4975-a5ae-734c6efe341a';  // 100 Exam - NP Child (45 min)\nconst DEFAULT_MINUTES = 45;\n\nfunction isValidGUID(value) {\n    if (!value || typeof value !== 'string') return false;\n    return /^[a-f0-9]{8}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{12}$/i.test(value);\n}\n\n// ============================================================================\n// XML BUILDER HELPERS\n// ============================================================================\n\nfunction buildXmlRequest(procedure, parameters = '') {\n    return `<?xml version=\"1.0\" encoding=\"utf-8\" ?>\n<GetDataRequest xmlns=\"http://schemas.practica.ws/cloud9/partners/\">\n    <ClientID>${CLOUD9_CONFIG.clientId}</ClientID>\n    <UserName>${CLOUD9_CONFIG.userName}</UserName>\n    <Password>${CLOUD9_CONFIG.password}</Password>\n    <Procedure>${procedure}</Procedure>\n    <Parameters>${parameters}</Parameters>\n</GetDataRequest>`;\n}\n\nfunction parseXmlResponse(xml) {\n    const statusMatch = xml.match(/<ResponseStatus>([^<]+)/);\n    if (statusMatch && statusMatch[1] === 'Error') {\n        const errorMsg = xml.match(/<ErrorMessage>([^<]+)/);\n        throw new Error(errorMsg ? errorMsg[1] : 'Cloud9 API Error');\n    }\n    return xml;\n}\n\n// ============================================================================\n// CLOUD9 API CALL\n// ============================================================================\n\nfunction callCloud9(procedure, parameters = '') {\n    return new Promise((resolve, reject) => {\n        const xml = buildXmlRequest(procedure, parameters);\n        \n        console.log(`[Cloud9 TEST] Calling ${procedure}`);\n        \n        const options = {\n            hostname: CLOUD9_CONFIG.hostname,\n            path: CLOUD9_CONFIG.path,\n            method: 'POST',\n            headers: {\n                'Content-Type': 'application/xml',\n                'Content-Length': Buffer.byteLength(xml)\n            }\n        };\n        \n        const req = https.request(options, (res) => {\n            let data = '';\n            res.on('data', chunk => data += chunk);\n            res.on('end', () => {\n                try {\n                    parseXmlResponse(data);\n                    resolve(data);\n                } catch (e) {\n                    reject(e);\n                }\n            });\n        });\n        \n        req.on('error', e => reject(e));\n        req.setTimeout(60000, () => {\n            req.destroy();\n            reject(new Error('Request timeout'));\n        });\n        req.write(xml);\n        req.end();\n    });\n}\n\n// ============================================================================\n// DATE HELPERS\n// ============================================================================\n\nfunction formatDate(date) {\n    const mm = String(date.getMonth() + 1).padStart(2, '0');\n    const dd = String(date.getDate()).padStart(2, '0');\n    return `${mm}/${dd}/${date.getFullYear()}`;\n}\n\nfunction parseDate(dateStr) {\n    if (!dateStr) return null;\n    const parts = dateStr.split('/');\n    if (parts.length !== 3) return null;\n    return new Date(parseInt(parts[2]), parseInt(parts[0]) - 1, parseInt(parts[1]));\n}\n\nfunction getDefaultDateRange() {\n    const today = new Date();\n    today.setHours(0, 0, 0, 0);\n    const endDate = new Date(today);\n    endDate.setDate(endDate.getDate() + 14); // 2 weeks\n    return {\n        startDate: formatDate(today),\n        endDate: formatDate(endDate)\n    };\n}\n\n// ============================================================================\n// ACTION HANDLERS\n// ============================================================================\n\nasync function handleSlots(params) {\n    const dateRange = getDefaultDateRange();\n    let startDate = params.startDate || dateRange.startDate;\n    let endDate = params.endDate || dateRange.endDate;\n    \n    // Validate and fix dates\n    const today = new Date();\n    today.setHours(0, 0, 0, 0);\n    \n    let parsedStart = parseDate(startDate);\n    let parsedEnd = parseDate(endDate);\n    \n    if (!parsedStart || parsedStart < today) {\n        parsedStart = today;\n        startDate = formatDate(parsedStart);\n    }\n    if (!parsedEnd || parsedEnd <= parsedStart) {\n        parsedEnd = new Date(parsedStart);\n        parsedEnd.setDate(parsedEnd.getDate() + 14);\n        endDate = formatDate(parsedEnd);\n    }\n    \n    console.log(`[slots] Searching ${startDate} to ${endDate}`);\n    \n    const scheduleViewGUID = isValidGUID(params.scheduleViewGUID) ? params.scheduleViewGUID : DEFAULT_SCHEDULE_VIEW_GUID;\n    const apptTypeGUID = isValidGUID(params.appointmentTypeGUID) ? params.appointmentTypeGUID : DEFAULT_APPT_TYPE_GUID;\n    \n    const parameters = `\n        <startDate>${startDate} 8:00:00 AM</startDate>\n        <endDate>${endDate} 5:00:00 PM</endDate>\n        <morning>True</morning>\n        <afternoon>True</afternoon>\n        <appttypGUIDs>${apptTypeGUID}</appttypGUIDs>\n        <schdvwGUIDs>${scheduleViewGUID}</schdvwGUIDs>\n        <locationGUID>${DEFAULT_LOCATION_GUID}</locationGUID>`;\n    \n    const xml = await callCloud9('GetOnlineReservations', parameters);\n    \n    // Parse slots from XML\n    const slots = [];\n    const records = xml.split(/<Record>/).slice(1);\n    \n    records.forEach(rec => {\n        const startTime = rec.match(/<StartTime>([^<]+)/);\n        const schdvwGUID = rec.match(/<ScheduleViewGUID>([^<]+)/);\n        const schdcolGUID = rec.match(/<ScheduleColumnGUID>([^<]+)/);\n        const appttypGUID = rec.match(/<AppointmentTypeGUID>([^<]+)/);\n        const minutes = rec.match(/<Minutes>([^<]+)/);\n        \n        if (startTime) {\n            slots.push({\n                displayTime: startTime[1],\n                startTime: startTime[1],\n                scheduleViewGUID: schdvwGUID ? schdvwGUID[1] : scheduleViewGUID,\n                scheduleColumnGUID: schdcolGUID ? schdcolGUID[1] : DEFAULT_SCHEDULE_COLUMN_GUID,\n                appointmentTypeGUID: appttypGUID ? appttypGUID[1] : apptTypeGUID,\n                minutes: minutes ? parseInt(minutes[1]) : DEFAULT_MINUTES\n            });\n        }\n    });\n    \n    // Limit and return\n    const limitedSlots = slots.slice(0, MAX_SLOTS_RETURNED);\n    \n    return {\n        success: true,\n        slots: limitedSlots,\n        count: limitedSlots.length,\n        _toolVersion: TOOL_VERSION,\n        _dateRange: { start: startDate, end: endDate },\n        llm_guidance: {\n            timestamp: new Date().toISOString(),\n            confirmation_triggers: ['yes', 'yeah', 'yep', 'sure', 'okay', 'ok', 'perfect', 'sounds good'],\n            BOOKING_SEQUENCE_MANDATORY: [\n                'STEP 1: Offer the slot time to the caller and wait for confirmation',\n                'STEP 2: When caller confirms, FIRST call chord_ortho_patient action=create to create the patient',\n                'STEP 3: Get the patientGUID from the chord_ortho_patient response',\n                'STEP 4: THEN call schedule_appointment_ortho action=book_child with patientGUID from step 3 AND slot GUIDs from this response',\n                'CRITICAL: NEVER call book_child before chord_ortho_patient create. The patientGUID is REQUIRED.'\n            ],\n            next_action: 'offer_time_to_caller_and_wait_for_confirmation',\n            on_caller_confirms: 'call_chord_ortho_patient_action_create_FIRST_then_book_child',\n            slot_fields_for_booking: 'startTime, scheduleViewGUID, scheduleColumnGUID, appointmentTypeGUID, minutes'\n        }\n    };\n}\n\nasync function handleBookChild(params) {\n    if (!params.patientGUID) throw new Error('BOOKING FAILED - Missing patientGUID. You MUST call chord_ortho_patient action=create FIRST.');\n    if (!params.startTime) throw new Error('BOOKING FAILED - Missing startTime');\n    \n    const scheduleViewGUID = isValidGUID(params.scheduleViewGUID) ? params.scheduleViewGUID : DEFAULT_SCHEDULE_VIEW_GUID;\n    const scheduleColumnGUID = isValidGUID(params.scheduleColumnGUID) ? params.scheduleColumnGUID : DEFAULT_SCHEDULE_COLUMN_GUID;\n    const appointmentTypeGUID = isValidGUID(params.appointmentTypeGUID) ? params.appointmentTypeGUID : DEFAULT_APPT_TYPE_GUID;\n    const minutes = params.minutes || DEFAULT_MINUTES;\n    \n    console.log(`[book_child] Booking for patient ${params.patientGUID} at ${params.startTime}`);\n    \n    const parameters = `\n        <PatientGUID>${params.patientGUID}</PatientGUID>\n        <StartTime>${params.startTime}</StartTime>\n        <ScheduleViewGUID>${scheduleViewGUID}</ScheduleViewGUID>\n        <ScheduleColumnGUID>${scheduleColumnGUID}</ScheduleColumnGUID>\n        <AppointmentTypeGUID>${appointmentTypeGUID}</AppointmentTypeGUID>\n        <Minutes>${minutes}</Minutes>\n        <VendorUserName>FlowiseTest</VendorUserName>`;\n    \n    const xml = await callCloud9('SetAppointment', parameters);\n    \n    // Extract appointment GUID from response\n    const guidMatch = xml.match(/([a-f0-9]{8}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{12})/i);\n    const appointmentGUID = guidMatch ? guidMatch[1] : null;\n    \n    return {\n        success: true,\n        appointmentGUID: appointmentGUID,\n        message: 'Appointment booked successfully',\n        startTime: params.startTime,\n        patientGUID: params.patientGUID,\n        _toolVersion: TOOL_VERSION,\n        llm_guidance: {\n            current_state: 'BOOKING_COMPLETE',\n            next_action: 'confirm_to_caller',\n            voice_response: `Your appointment has been booked for ${params.startTime}. Is there anything else I can help you with?`\n        }\n    };\n}\n\nasync function handleCancel(params) {\n    if (!params.appointmentGUID) throw new Error('appointmentGUID is required');\n    \n    const parameters = `<apptGUIDs>${params.appointmentGUID}</apptGUIDs>`;\n    await callCloud9('CancelExistingAppts', parameters);\n    \n    return {\n        success: true,\n        message: 'Appointment cancelled successfully',\n        appointmentGUID: params.appointmentGUID,\n        _toolVersion: TOOL_VERSION\n    };\n}\n\n// ============================================================================\n// MAIN EXECUTION\n// ============================================================================\n\nasync function executeRequest() {\n    const toolName = 'schedule_appointment_ortho';\n    const action = $action;\n    \n    console.log(`[${toolName}] ${TOOL_VERSION} - Cloud9 TEST Direct`);\n    console.log(`[${toolName}] Action: ${action}`);\n    \n    const validActions = ['slots', 'grouped_slots', 'book_child', 'cancel'];\n    if (!action || !validActions.includes(action)) {\n        throw new Error(`Invalid action '${action}'. Valid actions: ${validActions.join(', ')}`);\n    }\n    \n    // Build params from Flowise variables\n    const params = {};\n    if (typeof $startDate !== 'undefined' && $startDate) params.startDate = $startDate;\n    if (typeof $endDate !== 'undefined' && $endDate) params.endDate = $endDate;\n    if (typeof $patientGUID !== 'undefined' && $patientGUID) params.patientGUID = $patientGUID;\n    if (typeof $startTime !== 'undefined' && $startTime) params.startTime = $startTime;\n    if (typeof $scheduleViewGUID !== 'undefined' && $scheduleViewGUID) params.scheduleViewGUID = $scheduleViewGUID;\n    if (typeof $scheduleColumnGUID !== 'undefined' && $scheduleColumnGUID) params.scheduleColumnGUID = $scheduleColumnGUID;\n    if (typeof $appointmentTypeGUID !== 'undefined' && $appointmentTypeGUID) params.appointmentTypeGUID = $appointmentTypeGUID;\n    if (typeof $minutes !== 'undefined' && $minutes) params.minutes = $minutes;\n    if (typeof $appointmentGUID !== 'undefined' && $appointmentGUID) params.appointmentGUID = $appointmentGUID;\n    if (typeof $childName !== 'undefined' && $childName) params.childName = $childName;\n    \n    try {\n        let result;\n        switch (action) {\n            case 'slots':\n            case 'grouped_slots':\n                result = await handleSlots(params);\n                break;\n            case 'book_child':\n                result = await handleBookChild(params);\n                break;\n            case 'cancel':\n                result = await handleCancel(params);\n                break;\n            default:\n                throw new Error(`Action '${action}' not implemented`);\n        }\n        \n        console.log(`[${toolName}] Success:`, JSON.stringify(result).substring(0, 300));\n        return JSON.stringify(result);\n        \n    } catch (error) {\n        console.error(`[${toolName}] Error:`, error.message);\n        \n        if (error.message.includes('BOOKING FAILED') || error.message.includes('Missing')) {\n            return JSON.stringify({\n                success: false,\n                _toolVersion: TOOL_VERSION,\n                _debug_error: error.message,\n                llm_guidance: {\n                    error_type: 'missing_params',\n                    voice_response: 'Let me check those details again.',\n                    action_required: 'provide_required_params',\n                    CRITICAL: 'book_child requires patientGUID. Call chord_ortho_patient action=create FIRST to get patientGUID.'\n                }\n            });\n        }\n        \n        throw new Error(JSON.stringify({\n            error: `Failed to execute ${action}`,\n            message: error.message,\n            action: action,\n            timestamp: new Date().toISOString()\n        }));\n    }\n}\n\nreturn executeRequest();\n",
  "workspaceId": "9e7c759d-2623-4529-945d-6c578631aad0"
}
