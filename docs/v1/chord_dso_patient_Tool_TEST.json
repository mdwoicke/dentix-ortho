{
  "name": "chord_ortho_patient",
  "description": "Unified patient and clinic tool for TEST/Sandbox environment. Use action 'lookup' to find patient by phone number or name, 'get' to retrieve patient by ID, 'create' to register a new patient, 'appointments' to get patient's scheduled appointments, 'clinic_info' to get clinic details like name and address, 'edit_insurance' to change an existing patient's insurance provider, or 'confirm_appointment' to confirm a patient's appointment by appointmentId.",
  "color": "linear-gradient(rgb(58,159,203), rgb(65,135,54))",
  "iconSrc": "",
  "schema": "[{\"id\":0,\"property\":\"action\",\"type\":\"string\",\"description\":\"The operation to perform. Valid values: lookup, get, create, appointments, clinic_info, edit_insurance, confirm_appointment\",\"required\":true},{\"id\":1,\"property\":\"phoneNumber\",\"type\":\"string\",\"description\":\"Phone number for patient lookup\",\"required\":false},{\"id\":2,\"property\":\"filter\",\"type\":\"string\",\"description\":\"LastName, FirstName or Patient ID for lookup\",\"required\":false},{\"id\":3,\"property\":\"patientGUID\",\"type\":\"string\",\"description\":\"Patient GUID for get/appointments/edit_insurance actions\",\"required\":false},{\"id\":4,\"property\":\"patientFirstName\",\"type\":\"string\",\"description\":\"Patient first name for create action\",\"required\":false},{\"id\":5,\"property\":\"patientLastName\",\"type\":\"string\",\"description\":\"Patient last name for create action\",\"required\":false},{\"id\":6,\"property\":\"birthdayDateTime\",\"type\":\"string\",\"description\":\"Patient date of birth in MM/DD/YYYY format\",\"required\":false},{\"id\":7,\"property\":\"gender\",\"type\":\"string\",\"description\":\"Patient gender. Valid values: M, F\",\"required\":false},{\"id\":8,\"property\":\"emailAddress\",\"type\":\"string\",\"description\":\"Email address for patient account\",\"required\":false},{\"id\":9,\"property\":\"providerGUID\",\"type\":\"string\",\"description\":\"Provider GUID\",\"required\":false},{\"id\":10,\"property\":\"locationGUID\",\"type\":\"string\",\"description\":\"Location GUID for the practice\",\"required\":false},{\"id\":11,\"property\":\"insuranceProvider\",\"type\":\"string\",\"description\":\"Insurance provider name\",\"required\":false},{\"id\":12,\"property\":\"insuranceGroupId\",\"type\":\"string\",\"description\":\"Insurance group ID\",\"required\":false},{\"id\":13,\"property\":\"insuranceMemberId\",\"type\":\"string\",\"description\":\"Insurance member ID\",\"required\":false},{\"id\":14,\"property\":\"appointmentId\",\"type\":\"string\",\"description\":\"Appointment GUID for confirm_appointment action\",\"required\":false}]",
  "func": "/**\n * ============================================================================\n * CHORD DSO PATIENT - Unified Patient & Clinic Tool (TEST Cloud9 Direct)\n * Version: v5-TEST | Updated: 2026-01-13\n * ============================================================================\n * Consolidates: lookup, get, create, appointments, clinic_info\n * \n * This version calls Cloud9 TEST SANDBOX directly via XML/SOAP.\n * For Sandbox A testing only - NOT for production.\n * ============================================================================\n */\n\nconst https = require('https');\n\n// ============================================================================\n// TEST CLOUD9 CONFIGURATION\n// ============================================================================\n\nconst CLOUD9_CONFIG = {\n    hostname: 'us-ea1-partnertest.cloud9ortho.com',\n    path: '/GetData.ashx',\n    clientId: 'c15aa02a-adc1-40ae-a2b5-d2e39173ae56',\n    userName: 'IntelepeerTest',\n    password: '#!InteleP33rTest!#'\n};\n\n// Default GUIDs for TEST environment (Location14 - verified working in Postman)\nconst DEFAULT_LOCATION_GUID = '1070d281-0952-4f01-9a6e-1a2e6926a7db';  // Location14\nconst DEFAULT_PROVIDER_GUID = '79ec29fe-c315-4982-845a-0005baefb5a8';  // TEST Provider\n\nfunction isValidGUID(value) {\n    if (!value || typeof value !== 'string') return false;\n    return /^[a-f0-9]{8}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{12}$/i.test(value);\n}\n\n// ============================================================================\n// XML BUILDER HELPERS\n// ============================================================================\n\nfunction buildXmlRequest(procedure, parameters = '') {\n    return `<?xml version=\"1.0\" encoding=\"utf-8\" ?>\n<GetDataRequest xmlns=\"http://schemas.practica.ws/cloud9/partners/\">\n    <ClientID>${CLOUD9_CONFIG.clientId}</ClientID>\n    <UserName>${CLOUD9_CONFIG.userName}</UserName>\n    <Password>${CLOUD9_CONFIG.password}</Password>\n    <Procedure>${procedure}</Procedure>\n    <Parameters>${parameters}</Parameters>\n</GetDataRequest>`;\n}\n\nfunction parseXmlResponse(xml) {\n    // Check for error\n    const statusMatch = xml.match(/<ResponseStatus>([^<]+)/);\n    if (statusMatch && statusMatch[1] === 'Error') {\n        const errorMsg = xml.match(/<ErrorMessage>([^<]+)/);\n        throw new Error(errorMsg ? errorMsg[1] : 'Cloud9 API Error');\n    }\n    return xml;\n}\n\nfunction extractRecords(xml, fields) {\n    const records = [];\n    const recordMatches = xml.split(/<Record>/).slice(1);\n    recordMatches.forEach(rec => {\n        const record = {};\n        fields.forEach(field => {\n            const match = rec.match(new RegExp(`<${field}>([^<]*)`));\n            if (match) record[field] = match[1];\n        });\n        if (Object.keys(record).length > 0) records.push(record);\n    });\n    return records;\n}\n\n// ============================================================================\n// CLOUD9 API CALL\n// ============================================================================\n\nfunction callCloud9(procedure, parameters = '') {\n    return new Promise((resolve, reject) => {\n        const xml = buildXmlRequest(procedure, parameters);\n        \n        const options = {\n            hostname: CLOUD9_CONFIG.hostname,\n            path: CLOUD9_CONFIG.path,\n            method: 'POST',\n            headers: {\n                'Content-Type': 'application/xml',\n                'Content-Length': Buffer.byteLength(xml)\n            }\n        };\n        \n        const req = https.request(options, (res) => {\n            let data = '';\n            res.on('data', chunk => data += chunk);\n            res.on('end', () => {\n                try {\n                    parseXmlResponse(data);\n                    resolve(data);\n                } catch (e) {\n                    reject(e);\n                }\n            });\n        });\n        \n        req.on('error', e => reject(e));\n        req.setTimeout(60000, () => {\n            req.destroy();\n            reject(new Error('Request timeout'));\n        });\n        req.write(xml);\n        req.end();\n    });\n}\n\n// ============================================================================\n// ACTION HANDLERS\n// ============================================================================\n\nasync function handleLookup(params) {\n    // Use GetPortalPatientLookup for patient search\n    const filter = params.filter || params.phoneNumber || '';\n    const parameters = `<filter>${filter}</filter><lookupByPatient>1</lookupByPatient><showInactive>0</showInactive>`;\n    \n    const xml = await callCloud9('GetPortalPatientLookup', parameters);\n    const records = extractRecords(xml, ['PatientName', 'PatientID', 'PatientBirthDate', 'PatientGUID', 'ResponsiblePartyName']);\n    \n    return {\n        success: true,\n        patients: records,\n        count: records.length\n    };\n}\n\nasync function handleGet(params) {\n    if (!params.patientGUID) throw new Error('patientGUID is required');\n    \n    const parameters = `<patGUID>${params.patientGUID}</patGUID>`;\n    const xml = await callCloud9('GetPatientInformation', parameters);\n    const records = extractRecords(xml, ['FullName', 'BirthDate', 'Email', 'Phone', 'Orthodontist', 'patGUID']);\n    \n    return {\n        success: true,\n        patient: records[0] || null\n    };\n}\n\nasync function handleCreate(params) {\n    if (!params.patientFirstName) throw new Error('patientFirstName is required');\n    if (!params.patientLastName) throw new Error('patientLastName is required');\n    \n    const providerGUID = isValidGUID(params.providerGUID) ? params.providerGUID : DEFAULT_PROVIDER_GUID;\n    const locationGUID = isValidGUID(params.locationGUID) ? params.locationGUID : DEFAULT_LOCATION_GUID;\n    \n    let parameters = `\n        <patientFirstName>${params.patientFirstName}</patientFirstName>\n        <patientLastName>${params.patientLastName}</patientLastName>\n        <providerGUID>${providerGUID}</providerGUID>\n        <locationGUID>${locationGUID}</locationGUID>\n        <VendorUserName>FlowiseTest</VendorUserName>`;\n    \n    if (params.birthdayDateTime) parameters += `<birthdayDateTime>${params.birthdayDateTime}</birthdayDateTime>`;\n    if (params.gender) parameters += `<gender>${params.gender}</gender>`;\n    if (params.phoneNumber) parameters += `<phoneNumber>${params.phoneNumber}</phoneNumber>`;\n    if (params.emailAddress) parameters += `<addressEmail>${params.emailAddress}</addressEmail>`;\n    \n    const xml = await callCloud9('SetPatient', parameters);\n    \n    // Extract patient GUID from response\n    const guidMatch = xml.match(/([a-f0-9]{8}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{12})/i);\n    const patientGUID = guidMatch ? guidMatch[1] : null;\n    \n    if (!patientGUID) {\n        throw new Error('Patient creation failed - no GUID returned');\n    }\n    \n    return {\n        success: true,\n        patientGUID: patientGUID,\n        message: 'Patient created successfully',\n        llm_guidance: {\n            current_state: 'EXECUTE_BOOKING',\n            next_action: 'call_book_child_immediately',\n            critical_instruction: 'Patient created successfully. You MUST now IMMEDIATELY call schedule_appointment_ortho with action=book_child using this patientGUID. Do NOT say Let me check or One moment. Do NOT respond to caller until booking is complete.',\n            patientGUID_for_booking: patientGUID,\n            booking_sequence: 'After patient create -> IMMEDIATELY call book_child -> THEN confirm to caller'\n        }\n    };\n}\n\nasync function handleAppointments(params) {\n    if (!params.patientGUID) throw new Error('patientGUID is required');\n    \n    const parameters = `<patGUID>${params.patientGUID}</patGUID>`;\n    const xml = await callCloud9('GetAppointmentListByPatient', parameters);\n    const records = extractRecords(xml, ['AppointmentGUID', 'AppointmentDate', 'AppointmentTime', 'AppointmentType', 'LocationName', 'ProviderName']);\n    \n    return {\n        success: true,\n        appointments: records,\n        count: records.length\n    };\n}\n\nasync function handleClinicInfo(params) {\n    const xml = await callCloud9('GetLocations', '');\n    const records = extractRecords(xml, ['LocationName', 'LocationGUID', 'LocationAddress1', 'LocationCity', 'LocationState', 'LocationZip', 'LocationPhone']);\n    \n    // If locationGUID provided, filter to that location\n    let locations = records;\n    if (isValidGUID(params.locationGUID)) {\n        locations = records.filter(r => r.LocationGUID === params.locationGUID);\n    } else {\n        // Return default location only\n        locations = records.filter(r => r.LocationGUID === DEFAULT_LOCATION_GUID);\n        if (locations.length === 0) locations = records.slice(0, 1);\n    }\n    \n    return {\n        success: true,\n        locations: locations,\n        defaultLocationGUID: DEFAULT_LOCATION_GUID,\n        defaultProviderGUID: DEFAULT_PROVIDER_GUID\n    };\n}\n\n// ============================================================================\n// MAIN EXECUTION\n// ============================================================================\n\nasync function executeRequest() {\n    const toolName = 'chord_ortho_patient';\n    const action = $action;\n    \n    console.log(`[${toolName}] v5-TEST - Cloud9 TEST Direct`);\n    console.log(`[${toolName}] Action: ${action}`);\n    \n    const validActions = ['lookup', 'get', 'create', 'appointments', 'clinic_info', 'edit_insurance', 'confirm_appointment'];\n    if (!action || !validActions.includes(action)) {\n        throw new Error(`Invalid action '${action}'. Valid actions: ${validActions.join(', ')}`);\n    }\n    \n    // Build params from Flowise variables\n    const params = {};\n    if (typeof $phoneNumber !== 'undefined' && $phoneNumber) params.phoneNumber = $phoneNumber;\n    if (typeof $filter !== 'undefined' && $filter) params.filter = $filter;\n    if (typeof $patientGUID !== 'undefined' && $patientGUID) params.patientGUID = $patientGUID;\n    if (typeof $patientFirstName !== 'undefined' && $patientFirstName) params.patientFirstName = $patientFirstName;\n    if (typeof $patientLastName !== 'undefined' && $patientLastName) params.patientLastName = $patientLastName;\n    if (typeof $birthdayDateTime !== 'undefined' && $birthdayDateTime) params.birthdayDateTime = $birthdayDateTime;\n    if (typeof $gender !== 'undefined' && $gender) params.gender = $gender;\n    if (typeof $emailAddress !== 'undefined' && $emailAddress) params.emailAddress = $emailAddress;\n    if (typeof $providerGUID !== 'undefined' && $providerGUID) params.providerGUID = $providerGUID;\n    if (typeof $locationGUID !== 'undefined' && $locationGUID) params.locationGUID = $locationGUID;\n    if (typeof $appointmentId !== 'undefined' && $appointmentId) params.appointmentId = $appointmentId;\n    \n    try {\n        let result;\n        switch (action) {\n            case 'lookup':\n                result = await handleLookup(params);\n                break;\n            case 'get':\n                result = await handleGet(params);\n                break;\n            case 'create':\n                result = await handleCreate(params);\n                break;\n            case 'appointments':\n                result = await handleAppointments(params);\n                break;\n            case 'clinic_info':\n                result = await handleClinicInfo(params);\n                break;\n            default:\n                throw new Error(`Action '${action}' not implemented for TEST environment`);\n        }\n        \n        console.log(`[${toolName}] Success:`, JSON.stringify(result).substring(0, 200));\n        return JSON.stringify(result);\n        \n    } catch (error) {\n        console.error(`[${toolName}] Error:`, error.message);\n        throw new Error(JSON.stringify({\n            error: `Failed to execute ${action}`,\n            message: error.message,\n            action: action,\n            timestamp: new Date().toISOString()\n        }));\n    }\n}\n\nreturn executeRequest();\n",
  "workspaceId": "9e7c759d-2623-4529-945d-6c578631aad0"
}
