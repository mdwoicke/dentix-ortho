{
  "name": "chord_ortho_patient",
  "description": "Unified patient and clinic tool. Use action 'lookup' to find patient by phone/name, 'get' to retrieve by ID, 'create' to register new PARENT patient only (do NOT use isChild=true - child patients are created automatically by schedule_appointment_ortho book_child), 'appointments' to get scheduled appointments, 'clinic_info' for clinic details, 'edit_insurance' to update insurance, 'confirm_appointment' to confirm by appointmentId. IMPORTANT: For booking, use schedule_appointment_ortho action=book_child with parentFirstName + children array. Do NOT create child patients separately.",
  "color": "linear-gradient(rgb(58,159,203), rgb(65,135,54))",
  "iconSrc": "",
  "schema": "[{\"id\":0,\"property\":\"action\",\"type\":\"string\",\"description\":\"The operation to perform. Valid values: lookup, get, create, appointments, clinic_info, edit_insurance, confirm_appointment\",\"required\":true},{\"id\":1,\"property\":\"phoneNumber\",\"type\":\"string\",\"description\":\"Phone number for lookup or parent patient creation. Children do NOT get phone numbers.\",\"required\":false},{\"id\":2,\"property\":\"filter\",\"type\":\"string\",\"description\":\"LastName, FirstName or Patient ID for lookup\",\"required\":false},{\"id\":3,\"property\":\"patientGUID\",\"type\":\"string\",\"description\":\"Patient GUID for get/appointments/edit_insurance actions\",\"required\":false},{\"id\":4,\"property\":\"patientFirstName\",\"type\":\"string\",\"description\":\"Patient first name. For parent: use parent's name. For child (isChild=true): use child's name.\",\"required\":false},{\"id\":5,\"property\":\"patientLastName\",\"type\":\"string\",\"description\":\"Patient last name. For parent: use parent's name. For child (isChild=true): use child's name.\",\"required\":false},{\"id\":6,\"property\":\"birthdayDateTime\",\"type\":\"string\",\"description\":\"Date of birth in MM/DD/YYYY format. Required for children for age verification.\",\"required\":false},{\"id\":7,\"property\":\"gender\",\"type\":\"string\",\"description\":\"Patient gender. Valid values: M, F\",\"required\":false},{\"id\":8,\"property\":\"emailAddress\",\"type\":\"string\",\"description\":\"Email address (parent only, not for children)\",\"required\":false},{\"id\":9,\"property\":\"providerGUID\",\"type\":\"string\",\"description\":\"Provider GUID\",\"required\":false},{\"id\":10,\"property\":\"locationGUID\",\"type\":\"string\",\"description\":\"Location GUID for the practice\",\"required\":false},{\"id\":11,\"property\":\"insuranceProvider\",\"type\":\"string\",\"description\":\"Insurance provider/carrier name - stored on patient record via SetPatientComment\",\"required\":false},{\"id\":12,\"property\":\"insuranceGroupId\",\"type\":\"string\",\"description\":\"Insurance group ID\",\"required\":false},{\"id\":13,\"property\":\"insuranceMemberId\",\"type\":\"string\",\"description\":\"Insurance member ID\",\"required\":false},{\"id\":14,\"property\":\"appointmentId\",\"type\":\"string\",\"description\":\"Appointment GUID for confirm_appointment action\",\"required\":false},{\"id\":15,\"property\":\"isChild\",\"type\":\"boolean\",\"description\":\"Set to true when creating a child patient. Children have no phone and are linked to parent via familyId.\",\"required\":false},{\"id\":16,\"property\":\"parentPatientGUID\",\"type\":\"string\",\"description\":\"Parent's patientGUID. REQUIRED when isChild=true to link child to parent.\",\"required\":false},{\"id\":17,\"property\":\"familyId\",\"type\":\"string\",\"description\":\"Family identifier. Returns from parent create, REQUIRED when isChild=true.\",\"required\":false}]",
  "func": "/**\n * ============================================================================\n * CHORD DSO PATIENT - Unified Patient & Clinic Tool (Node Red Version)\n * Version: v14 | Updated: 2026-02-25\n * ============================================================================\n * Consolidates: lookup, get, create, appointments, clinic_info, edit_insurance, confirm_appointment\n *\n * This version calls Node Red endpoints instead of Cloud9 directly.\n * All Cloud9 XML/SOAP logic is handled by Node Red.\n *\n * v14: PII MASKING DETECTION - Catch masked phone numbers before hitting Node-RED\n *     - lookup.validate() rejects phoneNumber matching /^[*Xx]+$/\n *     - Returns helpful llm_guidance directing LLM to search by name instead\n *     - Prevents wasted API call and confusing error for the LLM\n *\n * v13: Updated DEFAULT_PROVIDER_GUID to Dr. Troy McCartney (0f588ace-e0bf-44ba-b8ef-be8cbb63153b)\n *\n * v12: FIX - Clarified that each child create returns THEIR OWN bookingAuthToken\n *     - Updated LLM guidance to emphasize child token usage (not parent's)\n *     - Works with scheduling tool v72 for correct token validation\n *\n * v11: REMOVED children array from create action - was dead code causing LLM confusion\n *     - Each child must be created with a SEPARATE create call (isChild=true)\n *     - Removed $children from rawParams to prevent LLM from passing children in single call\n *\n * v10: INDIVIDUAL_PATIENT_PER_PERSON MODEL\n *     - Each person (adult and child) gets their own unique patientGUID\n *     - PARENT: Created first with phone number, gets familyId generated\n *     - CHILD: Created with isChild=true, parentPatientGUID, familyId, NO phone\n *     - Appointments tie directly to child's patientGUID (not parent's)\n *     - Insurance/family linkage stored via SetPatientComment on child's record\n *     - New params: isChild (boolean), parentPatientGUID (string), familyId (string)\n *     - New params: insurance.provider, insurance.groupId, insurance.memberId\n *\n * v9: BOOKING AUTHORIZATION TOKEN\n *     - Returns bookingAuthToken on successful patient creation\n *     - Token MUST be passed to book_child to prevent parallel tool call collisions\n *     - Token validates that the patientGUID matches what was just created\n *     - Prevents LLM from using stale/hallucinated GUIDs in sibling booking\n *\n * v8: PARENT-AS-PATIENT MODEL (DEPRECATED - replaced by v10)\n * v7: SIBLING BOOKING FIX (DEPRECATED - see v10)\n * v6: Updated field descriptions in schema to clarify CHILD's info, not parent\n * v5: API CALL TRACING - Add _debug_calls array to track all HTTP calls\n * v4: General improvements\n * v3: Fixed clinic_info to use DEFAULT_LOCATION_GUID\n * v2: Added default locationGUID and providerGUID with GUID validation\n * ============================================================================\n */\n\nconst fetch = require('node-fetch');\n\nconst TOOL_VERSION = 'v14';\n\n// v5: API Call Tracking for debugging - enables Call Flow Navigator visualization\nconst _debug_calls = [];\n\n/**\n * Tracked fetch wrapper that records all HTTP calls for debugging\n * Captures: endpoint, method, request body, response, timing, status\n */\nasync function trackedFetch(url, options = {}) {\n    const startTime = Date.now();\n    const callId = _debug_calls.length + 1;\n    const callInfo = {\n        id: callId,\n        layer: url.includes('cloud9') || url.includes('GetData.ashx') ? 'L1_Cloud9' : 'L2_NodeRED',\n        endpoint: url,\n        method: options.method || 'GET',\n        requestBody: options.body ? (() => { try { return JSON.parse(options.body); } catch(e) { return options.body; } })() : null,\n        startTime: new Date().toISOString(),\n        durationMs: null,\n        status: null,\n        response: null,\n        error: null\n    };\n\n    try {\n        const response = await fetch(url, options);\n        const responseText = await response.text();\n        let responseData;\n        try { responseData = JSON.parse(responseText); } catch (e) { responseData = responseText; }\n\n        callInfo.durationMs = Date.now() - startTime;\n        callInfo.status = response.status;\n        // v8 FIX: Store deep copy to prevent circular JSON reference\n        // (responseData._debug_calls would point back to responseData otherwise)\n        callInfo.response = JSON.parse(JSON.stringify(responseData));\n        callInfo.success = response.ok;\n\n        _debug_calls.push(callInfo);\n        console.log('[v7 TRACE] Call #' + callId + ' to ' + callInfo.layer + ': ' + url + ' -> ' + response.status + ' (' + callInfo.durationMs + 'ms)');\n\n        // Return a mock response object that mimics fetch response\n        return {\n            ok: response.ok,\n            status: response.status,\n            statusText: response.statusText,\n            headers: response.headers,\n            text: async () => responseText,\n            json: async () => responseData\n        };\n    } catch (error) {\n        callInfo.durationMs = Date.now() - startTime;\n        callInfo.error = error.message;\n        callInfo.success = false;\n        _debug_calls.push(callInfo);\n        console.log('[v7 TRACE] Call #' + callId + ' FAILED: ' + error.message);\n        throw error;\n    }\n}\n\n// ============================================================================\n// DEFAULT GUIDS - Production values for CDH Allegheny\n// ============================================================================\n\nconst DEFAULT_LOCATION_GUID = '1fef9297-7c8b-426b-b0d1-f2275136e48b';  // CDH - Allegheny 202 (PROD)\nconst DEFAULT_PROVIDER_GUID = '0f588ace-e0bf-44ba-b8ef-be8cbb63153b';  // Dr. Troy McCartney (TRMC)\n\nfunction isValidGUID(value) {\n    if (!value || typeof value !== 'string') return false;\n    return /^[a-f0-9]{8}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{12}$/i.test(value);\n}\n\n// ============================================================================\n// ACTION CONFIGURATIONS - Node Red Endpoints\n// ============================================================================\n\nconst BASE_URL = 'https://c1-aicoe-nodered-lb.prod.c1conversations.io/FabricWorkflow/api/chord';\n\nconst ACTIONS = {\n    lookup: {\n        endpoint: `${BASE_URL}/ortho-prd/getPatientByFilter`,\n        method: 'POST',\n        buildBody: (params, uui) => ({\n            uui: uui,\n            phoneNumber: params.phoneNumber,\n            filter: params.filter,\n            locationGUID: params.locationGUID\n        }),\n        validate: (params) => {\n            if (!params.phoneNumber && !params.filter) {\n                throw new Error(\"phoneNumber or filter is required for 'lookup' action\");\n            }\n            // v14: PII masking detection - catch masked phone numbers before API call\n            if (params.phoneNumber && /^[\\\\*Xx]+$/.test(params.phoneNumber.trim())) {\n                throw new Error(JSON.stringify({\n                    success: false,\n                    error: 'PII_MASKED_PHONE',\n                    llm_guidance: {\n                        error_type: 'pii_masked_phone',\n                        voice_response: 'I can look you up by name instead. Could you spell your last name for me?',\n                        action_required: 'search_by_name',\n                        CRITICAL: 'v14: The phone number appears to be PII-masked (e.g., \"***\"). Do NOT retry with the same value. Ask the caller for their name and use filter parameter instead of phoneNumber.',\n                        example: { action: 'lookup', filter: 'LastName, FirstName' }\n                    }\n                }));\n            }\n        },\n        successLog: 'Patient lookup completed'\n    },\n    get: {\n        endpoint: `${BASE_URL}/ortho-prd/getPatient`,\n        method: 'POST',\n        buildBody: (params, uui) => ({\n            uui: uui,\n            patientGUID: params.patientGUID\n        }),\n        validate: (params) => {\n            if (!params.patientGUID) {\n                throw new Error(\"patientGUID is required for 'get' action\");\n            }\n        },\n        successLog: 'Patient retrieved successfully'\n    },\n    create: {\n        endpoint: `${BASE_URL}/ortho-prd/createPatient`,\n        method: 'POST',\n        buildBody: (params, uui) => {\n            // v10: INDIVIDUAL_PATIENT_PER_PERSON - build body based on isChild flag\n            const body = {\n                uui: uui,\n                patientFirstName: params.patientFirstName,\n                patientLastName: params.patientLastName,\n                birthdayDateTime: params.birthdayDateTime,\n                gender: params.gender,\n                providerGUID: isValidGUID(params.providerGUID) ? params.providerGUID : DEFAULT_PROVIDER_GUID,\n                locationGUID: isValidGUID(params.locationGUID) ? params.locationGUID : DEFAULT_LOCATION_GUID,\n                // v10: New params for child patient creation\n                isChild: params.isChild === true || params.isChild === 'true',\n                parentPatientGUID: params.parentPatientGUID,\n                familyId: params.familyId\n            };\n            // v10: Only parents get phone number, children have no phone\n            if (!body.isChild) {\n                body.phoneNumber = params.phoneNumber;\n                body.emailAddress = params.emailAddress;\n            }\n            // v10: Insurance stored on patient record (especially for children)\n            if (params.insuranceProvider || params.insuranceGroupId || params.insuranceMemberId) {\n                body.insurance = {\n                    provider: params.insuranceProvider,\n                    groupId: params.insuranceGroupId,\n                    memberId: params.insuranceMemberId\n                };\n            }\n            return body;\n        },\n        validate: (params) => {\n            // v13: BLOCK child creation - must use atomic booking via schedule_appointment_ortho book_child\n            const isChild = params.isChild === true || params.isChild === 'true';\n            if (isChild) {\n                throw new Error(\"ATOMIC_BOOKING_REQUIRED: Do NOT create child patients separately. Use schedule_appointment_ortho action=book_child with parentFirstName, parentLastName, parentPhone, and children array. Node-RED creates parent + children + books appointments in one atomic call.\");\n            }\n            if (!params.patientFirstName) throw new Error(\"patientFirstName (PARENT's first name) is required for 'create' action\");\n            if (!params.patientLastName) throw new Error(\"patientLastName (PARENT's last name) is required for 'create' action\");\n        },\n        successLog: 'Patient created successfully'\n    },\n    appointments: {\n        endpoint: `${BASE_URL}/ortho-prd/getPatientAppts`,\n        method: 'POST',\n        buildBody: (params, uui) => ({\n            uui: uui,\n            patientGUID: params.patientGUID\n        }),\n        validate: (params) => {\n            if (!params.patientGUID) {\n                throw new Error(\"patientGUID is required for 'appointments' action\");\n            }\n        },\n        successLog: 'Patient appointments retrieved'\n    },\n    clinic_info: {\n        endpoint: `${BASE_URL}/ortho-prd/getLocation`,\n        method: 'POST',\n        buildBody: (params, uui) => ({\n            uui: uui,\n            // v3: Use default if no valid locationGUID provided - prevents returning all locations\n            locationGUID: isValidGUID(params.locationGUID) ? params.locationGUID : DEFAULT_LOCATION_GUID\n        }),\n        validate: () => {},\n        successLog: 'Clinic info retrieved'\n    },\n    edit_insurance: {\n        endpoint: `${BASE_URL}/ortho-prd/editInsurance`,\n        method: 'POST',\n        buildBody: (params, uui) => ({\n            uui: uui,\n            patientGUID: params.patientGUID,\n            insuranceProvider: params.insuranceProvider,\n            insuranceGroupId: params.insuranceGroupId,\n            insuranceMemberId: params.insuranceMemberId\n        }),\n        validate: (params) => {\n            if (!params.patientGUID) {\n                throw new Error(\"patientGUID is required for 'edit_insurance' action\");\n            }\n        },\n        successLog: 'Patient insurance updated successfully'\n    },\n    confirm_appointment: {\n        endpoint: `${BASE_URL}/ortho-prd/confirmAppt`,\n        method: 'POST',\n        buildBody: (params, uui) => ({\n            uui: uui,\n            appointmentId: params.appointmentId\n        }),\n        validate: (params) => {\n            if (!params.appointmentId) {\n                throw new Error(\"appointmentId is required for 'confirm_appointment' action\");\n            }\n        },\n        successLog: 'Appointment confirmed successfully'\n    }\n};\n\n// ============================================================================\n// AUTHENTICATION\n// ============================================================================\n\nfunction getAuthHeader() {\n    try {\n        const username = \"workflowapi\";\n        const password = \"e^@V95&6sAJReTsb5!iq39mIC4HYIV\";\n        if (username && password) {\n            const credentials = Buffer.from(`${username}:${password}`).toString('base64');\n            return `Basic ${credentials}`;\n        }\n    } catch (e) {\n        return null;\n    }\n    return null;\n}\n\n// ============================================================================\n// ERROR DETECTION HELPER\n// ============================================================================\n\nfunction checkForError(data) {\n    if (!data || typeof data !== 'object') return null;\n\n    // Pattern 1: { success: false, error: \"...\" }\n    if (data.success === false) {\n        return data.error || data.message || 'Operation failed';\n    }\n\n    // Pattern 2: { code: false, error: [...] }\n    if (data.code === false) {\n        if (Array.isArray(data.error)) {\n            return data.error.join(', ');\n        }\n        return data.error || data.message || 'API returned error';\n    }\n\n    // Pattern 3: { error: \"...\" } without success/code field\n    if (data.error && !data.data && !data.patient && !data.patients && !data.appointments && !data.location && !data.locations) {\n        if (Array.isArray(data.error)) {\n            return data.error.join(', ');\n        }\n        return data.error;\n    }\n\n    return null;\n}\n\n// ============================================================================\n// PARAMETER CLEANER\n// ============================================================================\n\nfunction cleanParams(params) {\n    const cleaned = {};\n    for (const [key, value] of Object.entries(params)) {\n        if (value !== null && value !== undefined && value !== '' &&\n            value !== 'NULL' && value !== 'null' && value !== 'None' &&\n            value !== 'none' && value !== 'N/A' && value !== 'n/a') {\n            cleaned[key] = value;\n        }\n    }\n    return cleaned;\n}\n\n// ============================================================================\n// HTTP REQUEST ENGINE\n// ============================================================================\n\nasync function executeRequest() {\n    const toolName = 'chord_ortho_patient';\n    const action = $action;\n    const timeout = 60000; // 60 seconds for phone lookups which may check many patients\n\n    console.log(`[${toolName}] Action: ${action}`);\n\n    // Validate action\n    if (!action || !ACTIONS[action]) {\n        const validActions = Object.keys(ACTIONS).join(', ');\n        throw new Error(`Invalid action '${action}'. Valid actions: ${validActions}`);\n    }\n\n    const config = ACTIONS[action];\n\n    // Get UUI with fallback\n    let uui;\n    if (!$vars || !$vars.c1mg_uui || $vars.c1mg_uui === 'c1mg_uui' || (typeof $vars.c1mg_uui === 'string' && $vars.c1mg_uui.trim() === '')) {\n        uui = '765381306-000000000001030525-SR-000-000000000000DAL130-026DE427|333725|421458314VO|2d411063-3769-4618-86d1-925d3578c112|FSV';\n    } else {\n        uui = $vars.c1mg_uui;\n    }\n\n    // Build params object from Flowise variables\n    // v10: Added isChild, parentPatientGUID, familyId for INDIVIDUAL_PATIENT_PER_PERSON model\n    const rawParams = {\n        phoneNumber: typeof $phoneNumber !== 'undefined' ? $phoneNumber : null,\n        filter: typeof $filter !== 'undefined' ? $filter : null,\n        patientGUID: typeof $patientGUID !== 'undefined' ? $patientGUID : null,\n        patientFirstName: typeof $patientFirstName !== 'undefined' ? $patientFirstName : null,\n        patientLastName: typeof $patientLastName !== 'undefined' ? $patientLastName : null,\n        birthdayDateTime: typeof $birthdayDateTime !== 'undefined' ? $birthdayDateTime : null,\n        gender: typeof $gender !== 'undefined' ? $gender : null,\n        emailAddress: typeof $emailAddress !== 'undefined' ? $emailAddress : null,\n        providerGUID: typeof $providerGUID !== 'undefined' ? $providerGUID : null,\n        locationGUID: typeof $locationGUID !== 'undefined' ? $locationGUID : null,\n        insuranceProvider: typeof $insuranceProvider !== 'undefined' ? $insuranceProvider : null,\n        insuranceGroupId: typeof $insuranceGroupId !== 'undefined' ? $insuranceGroupId : null,\n        insuranceMemberId: typeof $insuranceMemberId !== 'undefined' ? $insuranceMemberId : null,\n        appointmentId: typeof $appointmentId !== 'undefined' ? $appointmentId : null,\n        // v11: REMOVED children param - was dead code causing LLM to think it could pass children in single create call\n        // Each child must be created with a SEPARATE create call (isChild=true)\n        // v10: INDIVIDUAL_PATIENT_PER_PERSON - new params for child patient creation\n        isChild: typeof $isChild !== 'undefined' ? $isChild : null,\n        parentPatientGUID: typeof $parentPatientGUID !== 'undefined' ? $parentPatientGUID : null,\n        familyId: typeof $familyId !== 'undefined' ? $familyId : null\n    };\n    const params = cleanParams(rawParams);\n\n    try {\n        // Validate required params for this action\n        config.validate(params);\n\n        const body = config.buildBody(params, uui);\n        console.log(`[${toolName}] Endpoint: ${config.method} ${config.endpoint}`);\n        console.log(`[${toolName}] Request Body:`, JSON.stringify(body, null, 2));\n\n        const headers = {\n            'Content-Type': 'application/json'\n        };\n\n        const authHeader = getAuthHeader();\n        if (authHeader) {\n            headers['Authorization'] = authHeader;\n        }\n\n        const options = {\n            method: config.method,\n            headers: headers,\n            body: JSON.stringify(body)\n        };\n\n        // Add timeout\n        let timeoutId;\n        if (typeof AbortController !== 'undefined') {\n            const controller = new AbortController();\n            timeoutId = setTimeout(() => controller.abort(), timeout);\n            options.signal = controller.signal;\n        }\n\n        console.log(`[${toolName}] Making request to Node Red...`);\n        const response = await trackedFetch(config.endpoint, options);\n\n        if (timeoutId) clearTimeout(timeoutId);\n\n        console.log(`[${toolName}] Response Status: ${response.status} ${response.statusText}`);\n\n        let data;\n        const contentType = response.headers.get('content-type');\n        if (contentType && contentType.includes('application/json')) {\n            data = await response.json();\n        } else {\n            data = await response.text();\n        }\n\n        // Check HTTP status\n        if (!response.ok) {\n            console.error(`[${toolName}] HTTP Error ${response.status}:`, data);\n            let errorMsg = `HTTP ${response.status}: ${response.statusText}`;\n            if (data) {\n                const bodyError = checkForError(typeof data === 'string' ? (() => { try { return JSON.parse(data); } catch(e) { return data; } })() : data);\n                if (bodyError) errorMsg = bodyError;\n            }\n            throw new Error(errorMsg);\n        }\n\n        // Parse response if string\n        let responseData = data;\n        if (typeof data === 'string') {\n            try { responseData = JSON.parse(data); } catch (e) { responseData = data; }\n        }\n\n        // Check for error patterns in successful HTTP response\n        const errorMessage = checkForError(responseData);\n        if (errorMessage) {\n            console.error(`[${toolName}] API Error:`, responseData);\n            throw new Error(errorMessage);\n        }\n\n        // v10: INDIVIDUAL_PATIENT_PER_PERSON MODEL - Different guidance for parent vs child\n        if (action === 'create' && responseData.success && responseData.patientGUID) {\n            const isChild = responseData.isChild === true;\n            if (isChild) {\n                // Child patient created - book appointment directly to this child's GUID\n                responseData.llm_guidance = {\n                    model: \"INDIVIDUAL_PATIENT_PER_PERSON\",\n                    current_state: \"CHILD_CREATED\",\n                    next_action: \"book_appointment_for_this_child\",\n                    critical_instruction: \"Child patient created with their OWN patientGUID. Book appointment using THIS patientGUID (not parent's). No child info needed in appointment note - child has their own record.\",\n                    childPatientGUID: responseData.patientGUID,\n                    parentPatientGUID: responseData.parentPatientGUID,\n                    familyId: responseData.familyId,\n                    bookingAuthToken_for_booking: responseData.bookingAuthToken,\n                    MUST_INCLUDE_IN_BOOK_CHILD: {\n                        patientGUID: responseData.patientGUID,\n                        bookingAuthToken: responseData.bookingAuthToken\n                    },\n                    IMPORTANT: \"Appointment ties directly to child's patient record. Use childPatientGUID for SetAppointment.\",\n                    booking_sequence: \"Child created -> book appointment using child's patientGUID -> confirm to caller\"\n                };\n            } else {\n                // Parent patient created - next step is to create each child\n                responseData.llm_guidance = {\n                    model: \"INDIVIDUAL_PATIENT_PER_PERSON\",\n                    current_state: \"PARENT_CREATED\",\n                    next_action: \"create_child_patients_then_book\",\n                    critical_instruction: \"Parent created. For EACH CHILD: 1) Call action=create with isChild=true. 2) Child create returns patientGUID + bookingAuthToken. 3) Book using CHILD's patientGUID + CHILD's bookingAuthToken.\",\n                    parentPatientGUID: responseData.patientGUID,\n                    familyId: responseData.familyId,\n                    // v12: REMOVED bookingAuthToken_for_children - each child gets their OWN token\n                    workflow: [\n                        \"1. Parent created (this response) - parentPatientGUID=\" + responseData.patientGUID + \", familyId=\" + responseData.familyId,\n                        \"2. For each child: call action=create with isChild=true, parentPatientGUID, familyId -> RETURNS child's patientGUID + child's bookingAuthToken\",\n                        \"3. For each child: book appointment using CHILD's patientGUID + CHILD's bookingAuthToken (both from step 2)\",\n                        \"4. Confirm all appointments to caller\"\n                    ],\n                    sibling_note: \"Each child gets their own patient record AND their own bookingAuthToken. Family linked via familyId.\",\n                    CRITICAL: \"v12: Each child has their OWN patientGUID AND bookingAuthToken. Do NOT use parent's values for child booking.\"\n                };\n            }\n        }\n\n        // v5: Add debug info to response for Call Flow Navigator\n        responseData._toolVersion = TOOL_VERSION;\n        responseData._debug_calls = _debug_calls;\n\n        console.log(`[${toolName}] ${config.successLog}`);\n        return JSON.stringify(responseData);\n\n    } catch (error) {\n        console.error(`[${toolName}] Error:`, error.message);\n\n        if (error.name === 'AbortError') {\n            error.message = `Request timeout after ${timeout}ms`;\n        }\n\n        const errorResponse = {\n            success: false,\n            error: `Failed to execute ${action}`,\n            message: error.message,\n            action: action,\n            timestamp: new Date().toISOString(),\n            _toolVersion: TOOL_VERSION,\n            _debug_error: error.message,\n            _debug_calls: _debug_calls\n        };\n\n        throw new Error(JSON.stringify(errorResponse, null, 2));\n    }\n}\n\nreturn executeRequest();\n",
  "workspaceId": "9e7c759d-2623-4529-945d-6c578631aad0"
}