{
  "name": "chord_ortho_patient",
  "description": "Unified patient and clinic tool. Use action 'lookup' to find patient by phone number or name, 'get' to retrieve patient by ID, 'create' to register a new patient, 'appointments' to get patient's scheduled appointments, 'clinic_info' to get clinic details like name and address, 'edit_insurance' to change an existing patient's insurance provider, or 'confirm_appointment' to confirm a patient's appointment by appointmentId.",
  "color": "linear-gradient(rgb(58,159,203), rgb(65,135,54))",
  "iconSrc": "",
  "schema": "[{\"id\":0,\"property\":\"action\",\"type\":\"string\",\"description\":\"The operation to perform. Valid values: lookup, get, create, appointments, clinic_info, edit_insurance, confirm_appointment\",\"required\":true},{\"id\":1,\"property\":\"phoneNumber\",\"type\":\"string\",\"description\":\"Phone number for patient lookup\",\"required\":false},{\"id\":2,\"property\":\"filter\",\"type\":\"string\",\"description\":\"LastName, FirstName or Patient ID for lookup\",\"required\":false},{\"id\":3,\"property\":\"patientGUID\",\"type\":\"string\",\"description\":\"Patient GUID for get/appointments/edit_insurance actions\",\"required\":false},{\"id\":4,\"property\":\"patientFirstName\",\"type\":\"string\",\"description\":\"Patient first name for create action\",\"required\":false},{\"id\":5,\"property\":\"patientLastName\",\"type\":\"string\",\"description\":\"Patient last name for create action\",\"required\":false},{\"id\":6,\"property\":\"birthdayDateTime\",\"type\":\"string\",\"description\":\"Patient date of birth in MM/DD/YYYY format\",\"required\":false},{\"id\":7,\"property\":\"gender\",\"type\":\"string\",\"description\":\"Patient gender. Valid values: M, F\",\"required\":false},{\"id\":8,\"property\":\"emailAddress\",\"type\":\"string\",\"description\":\"Email address for patient account\",\"required\":false},{\"id\":9,\"property\":\"providerGUID\",\"type\":\"string\",\"description\":\"Provider GUID\",\"required\":false},{\"id\":10,\"property\":\"locationGUID\",\"type\":\"string\",\"description\":\"Location GUID for the practice\",\"required\":false},{\"id\":11,\"property\":\"insuranceProvider\",\"type\":\"string\",\"description\":\"Insurance provider name\",\"required\":false},{\"id\":12,\"property\":\"insuranceGroupId\",\"type\":\"string\",\"description\":\"Insurance group ID\",\"required\":false},{\"id\":13,\"property\":\"insuranceMemberId\",\"type\":\"string\",\"description\":\"Insurance member ID\",\"required\":false},{\"id\":14,\"property\":\"appointmentId\",\"type\":\"string\",\"description\":\"Appointment GUID for confirm_appointment action\",\"required\":false}]",
  "func": "/**\n * ============================================================================\n * CHORD DSO PATIENT - Unified Patient & Clinic Tool (Node Red Version)\n * Version: v4 | Updated: 2026-01-12\n * ============================================================================\n * Consolidates: lookup, get, create, appointments, clinic_info, edit_insurance, confirm_appointment\n * \n * This version calls Node Red endpoints instead of Cloud9 directly.\n * All Cloud9 XML/SOAP logic is handled by Node Red.\n * \n * v3: Fixed clinic_info to use DEFAULT_LOCATION_GUID - prevents returning all locations\n * v2: Added default locationGUID and providerGUID with GUID validation\n * ============================================================================\n */\n\nconst fetch = require('node-fetch');\n\n// ============================================================================\n// ðŸ”§ DEFAULT GUIDS - Production values for CDH Allegheny\n// ============================================================================\n\nconst DEFAULT_LOCATION_GUID = '1fef9297-7c8b-426b-b0d1-f2275136e48b';  // CDH - Allegheny 202 (PROD)\nconst DEFAULT_PROVIDER_GUID = 'a79ec244-9503-44b2-87e4-5920b6e60392';  // Default Orthodontist\n\nfunction isValidGUID(value) {\n    if (!value || typeof value !== 'string') return false;\n    return /^[a-f0-9]{8}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{12}$/i.test(value);\n}\n\n// ============================================================================\n// ðŸ“ ACTION CONFIGURATIONS - Node Red Endpoints\n// ============================================================================\n\nconst BASE_URL = 'https://c1-aicoe-nodered-lb.prod.c1conversations.io/FabricWorkflow/api/chord';\n\nconst ACTIONS = {\n    lookup: {\n        endpoint: `${BASE_URL}/ortho-prd/getPatientByFilter`,\n        method: 'POST',\n        buildBody: (params, uui) => ({\n            uui: uui,\n            phoneNumber: params.phoneNumber,\n            filter: params.filter,\n            locationGUID: params.locationGUID\n        }),\n        validate: (params) => {\n            if (!params.phoneNumber && !params.filter) {\n                throw new Error(\"phoneNumber or filter is required for 'lookup' action\");\n            }\n        },\n        successLog: 'Patient lookup completed'\n    },\n    get: {\n        endpoint: `${BASE_URL}/ortho-prd/getPatient`,\n        method: 'POST',\n        buildBody: (params, uui) => ({\n            uui: uui,\n            patientGUID: params.patientGUID\n        }),\n        validate: (params) => {\n            if (!params.patientGUID) {\n                throw new Error(\"patientGUID is required for 'get' action\");\n            }\n        },\n        successLog: 'Patient retrieved successfully'\n    },\n    create: {\n        endpoint: `${BASE_URL}/ortho-prd/createPatient`,\n        method: 'POST',\n        buildBody: (params, uui) => ({\n            uui: uui,\n            patientFirstName: params.patientFirstName,\n            patientLastName: params.patientLastName,\n            birthdayDateTime: params.birthdayDateTime,\n            phoneNumber: params.phoneNumber,\n            emailAddress: params.emailAddress,\n            gender: params.gender,\n            providerGUID: isValidGUID(params.providerGUID) ? params.providerGUID : DEFAULT_PROVIDER_GUID,\n            locationGUID: isValidGUID(params.locationGUID) ? params.locationGUID : DEFAULT_LOCATION_GUID\n        }),\n        validate: (params) => {\n            if (!params.patientFirstName) throw new Error(\"patientFirstName is required for 'create' action\");\n            if (!params.patientLastName) throw new Error(\"patientLastName is required for 'create' action\");\n        },\n        successLog: 'Patient created successfully'\n    },\n    appointments: {\n        endpoint: `${BASE_URL}/ortho-prd/getPatientAppts`,\n        method: 'POST',\n        buildBody: (params, uui) => ({\n            uui: uui,\n            patientGUID: params.patientGUID\n        }),\n        validate: (params) => {\n            if (!params.patientGUID) {\n                throw new Error(\"patientGUID is required for 'appointments' action\");\n            }\n        },\n        successLog: 'Patient appointments retrieved'\n    },\n    clinic_info: {\n        endpoint: `${BASE_URL}/ortho-prd/getLocation`,\n        method: 'POST',\n        buildBody: (params, uui) => ({\n            uui: uui,\n            // v3: Use default if no valid locationGUID provided - prevents returning all locations\n            locationGUID: isValidGUID(params.locationGUID) ? params.locationGUID : DEFAULT_LOCATION_GUID\n        }),\n        validate: () => {},\n        successLog: 'Clinic info retrieved'\n    },\n    edit_insurance: {\n        endpoint: `${BASE_URL}/ortho-prd/editInsurance`,\n        method: 'POST',\n        buildBody: (params, uui) => ({\n            uui: uui,\n            patientGUID: params.patientGUID,\n            insuranceProvider: params.insuranceProvider,\n            insuranceGroupId: params.insuranceGroupId,\n            insuranceMemberId: params.insuranceMemberId\n        }),\n        validate: (params) => {\n            if (!params.patientGUID) {\n                throw new Error(\"patientGUID is required for 'edit_insurance' action\");\n            }\n        },\n        successLog: 'Patient insurance updated successfully'\n    },\n    confirm_appointment: {\n        endpoint: `${BASE_URL}/ortho-prd/confirmAppt`,\n        method: 'POST',\n        buildBody: (params, uui) => ({\n            uui: uui,\n            appointmentId: params.appointmentId\n        }),\n        validate: (params) => {\n            if (!params.appointmentId) {\n                throw new Error(\"appointmentId is required for 'confirm_appointment' action\");\n            }\n        },\n        successLog: 'Appointment confirmed successfully'\n    }\n};\n\n// ============================================================================\n// ðŸ” AUTHENTICATION\n// ============================================================================\n\nfunction getAuthHeader() {\n    try {\n        const username = \"workflowapi\";\n        const password = \"e^@V95&6sAJReTsb5!iq39mIC4HYIV\";\n        if (username && password) {\n            const credentials = Buffer.from(`${username}:${password}`).toString('base64');\n            return `Basic ${credentials}`;\n        }\n    } catch (e) {\n        return null;\n    }\n    return null;\n}\n\n// ============================================================================\n// ðŸ” ERROR DETECTION HELPER\n// ============================================================================\n\nfunction checkForError(data) {\n    if (!data || typeof data !== 'object') return null;\n    \n    // Pattern 1: { success: false, error: \"...\" }\n    if (data.success === false) {\n        return data.error || data.message || 'Operation failed';\n    }\n    \n    // Pattern 2: { code: false, error: [...] }\n    if (data.code === false) {\n        if (Array.isArray(data.error)) {\n            return data.error.join(', ');\n        }\n        return data.error || data.message || 'API returned error';\n    }\n    \n    // Pattern 3: { error: \"...\" } without success/code field\n    if (data.error && !data.data && !data.patient && !data.patients && !data.appointments && !data.location && !data.locations) {\n        if (Array.isArray(data.error)) {\n            return data.error.join(', ');\n        }\n        return data.error;\n    }\n    \n    return null;\n}\n\n// ============================================================================\n// ðŸ”§ PARAMETER CLEANER\n// ============================================================================\n\nfunction cleanParams(params) {\n    const cleaned = {};\n    for (const [key, value] of Object.entries(params)) {\n        if (value !== null && value !== undefined && value !== '' && \n            value !== 'NULL' && value !== 'null' && value !== 'None' && \n            value !== 'none' && value !== 'N/A' && value !== 'n/a') {\n            cleaned[key] = value;\n        }\n    }\n    return cleaned;\n}\n\n// ============================================================================\n// ðŸš€ HTTP REQUEST ENGINE\n// ============================================================================\n\nasync function executeRequest() {\n    const toolName = 'chord_ortho_patient';\n    const action = $action;\n    const timeout = 60000; // 60 seconds for phone lookups which may check many patients\n    \n    console.log(`[${toolName}] Action: ${action}`);\n    \n    // Validate action\n    if (!action || !ACTIONS[action]) {\n        const validActions = Object.keys(ACTIONS).join(', ');\n        throw new Error(`Invalid action '${action}'. Valid actions: ${validActions}`);\n    }\n    \n    const config = ACTIONS[action];\n    \n    // Get UUI with fallback\n    let uui;\n    if (!$vars || !$vars.c1mg_uui || $vars.c1mg_uui === 'c1mg_uui' || (typeof $vars.c1mg_uui === 'string' && $vars.c1mg_uui.trim() === '')) {\n        uui = '765381306-000000000001030525-SR-000-000000000000DAL130-026DE427|333725|421458314VO|2d411063-3769-4618-86d1-925d3578c112|FSV';\n    } else {\n        uui = $vars.c1mg_uui;\n    }\n    \n    // Build params object from Flowise variables\n    const rawParams = {\n        phoneNumber: typeof $phoneNumber !== 'undefined' ? $phoneNumber : null,\n        filter: typeof $filter !== 'undefined' ? $filter : null,\n        patientGUID: typeof $patientGUID !== 'undefined' ? $patientGUID : null,\n        patientFirstName: typeof $patientFirstName !== 'undefined' ? $patientFirstName : null,\n        patientLastName: typeof $patientLastName !== 'undefined' ? $patientLastName : null,\n        birthdayDateTime: typeof $birthdayDateTime !== 'undefined' ? $birthdayDateTime : null,\n        gender: typeof $gender !== 'undefined' ? $gender : null,\n        emailAddress: typeof $emailAddress !== 'undefined' ? $emailAddress : null,\n        providerGUID: typeof $providerGUID !== 'undefined' ? $providerGUID : null,\n        locationGUID: typeof $locationGUID !== 'undefined' ? $locationGUID : null,\n        insuranceProvider: typeof $insuranceProvider !== 'undefined' ? $insuranceProvider : null,\n        insuranceGroupId: typeof $insuranceGroupId !== 'undefined' ? $insuranceGroupId : null,\n        insuranceMemberId: typeof $insuranceMemberId !== 'undefined' ? $insuranceMemberId : null,\n        appointmentId: typeof $appointmentId !== 'undefined' ? $appointmentId : null\n    };\n    const params = cleanParams(rawParams);\n    \n    try {\n        // Validate required params for this action\n        config.validate(params);\n        \n        const body = config.buildBody(params, uui);\n        console.log(`[${toolName}] Endpoint: ${config.method} ${config.endpoint}`);\n        console.log(`[${toolName}] Request Body:`, JSON.stringify(body, null, 2));\n        \n        const headers = {\n            'Content-Type': 'application/json'\n        };\n        \n        const authHeader = getAuthHeader();\n        if (authHeader) {\n            headers['Authorization'] = authHeader;\n        }\n        \n        const options = {\n            method: config.method,\n            headers: headers,\n            body: JSON.stringify(body)\n        };\n        \n        // Add timeout\n        let timeoutId;\n        if (typeof AbortController !== 'undefined') {\n            const controller = new AbortController();\n            timeoutId = setTimeout(() => controller.abort(), timeout);\n            options.signal = controller.signal;\n        }\n        \n        console.log(`[${toolName}] Making request to Node Red...`);\n        const response = await fetch(config.endpoint, options);\n        \n        if (timeoutId) clearTimeout(timeoutId);\n        \n        console.log(`[${toolName}] Response Status: ${response.status} ${response.statusText}`);\n        \n        let data;\n        const contentType = response.headers.get('content-type');\n        if (contentType && contentType.includes('application/json')) {\n            data = await response.json();\n        } else {\n            data = await response.text();\n        }\n        \n        // Check HTTP status\n        if (!response.ok) {\n            console.error(`[${toolName}] HTTP Error ${response.status}:`, data);\n            let errorMsg = `HTTP ${response.status}: ${response.statusText}`;\n            if (data) {\n                const bodyError = checkForError(typeof data === 'string' ? (() => { try { return JSON.parse(data); } catch(e) { return data; } })() : data);\n                if (bodyError) errorMsg = bodyError;\n            }\n            throw new Error(errorMsg);\n        }\n        \n        // Parse response if string\n        let responseData = data;\n        if (typeof data === 'string') {\n            try { responseData = JSON.parse(data); } catch (e) { responseData = data; }\n        }\n        \n        // Check for error patterns in successful HTTP response\n        const errorMessage = checkForError(responseData);\n        if (errorMessage) {\n            console.error(`[${toolName}] API Error:`, responseData);\n            throw new Error(errorMessage);\n        }\n        \n        // Add LLM guidance for patient create success\n        if (action === 'create' && responseData.success && responseData.patientGUID) {\n            responseData.llm_guidance = {\n                current_state: \"EXECUTE_BOOKING\",\n                next_action: \"call_book_child_immediately\",\n                critical_instruction: \"Patient created successfully. You MUST now IMMEDIATELY call schedule_appointment_ortho with action=book_child using this patientGUID. Do NOT say 'Let me check' or 'One moment'. Do NOT respond to caller until booking is complete.\",\n                patientGUID_for_booking: responseData.patientGUID,\n                prohibited_responses: [\"Let me check on that\", \"One moment while I look into this\", \"I'm verifying\", \"Let me confirm\"],\n                booking_sequence: \"After patient create -> IMMEDIATELY call book_child -> THEN confirm to caller\"\n            };\n        }\n        \n        console.log(`[${toolName}] ${config.successLog}`);\n        return JSON.stringify(responseData);\n        \n    } catch (error) {\n        console.error(`[${toolName}] Error:`, error.message);\n        \n        if (error.name === 'AbortError') {\n            error.message = `Request timeout after ${timeout}ms`;\n        }\n        \n        const errorResponse = {\n            error: `Failed to execute ${action}`,\n            message: error.message,\n            action: action,\n            timestamp: new Date().toISOString()\n        };\n        \n        throw new Error(JSON.stringify(errorResponse, null, 2));\n    }\n}\n\nreturn executeRequest();\n",
  "workspaceId": "9e7c759d-2623-4529-945d-6c578631aad0"
}
