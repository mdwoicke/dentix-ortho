---
phase: 02-fulfillment-verification
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - backend/src/services/fulfillmentVerifier.ts
autonomous: true

must_haves:
  truths:
    - "For multi-child bookings, system groups claimed records by child name and verifies each child independently"
    - "Each child shows individual pass/fail for patient record AND appointment record"
    - "Overall verdict is 'partial' if some children verified but not all"
    - "Responsible party (parent) patient record is verified separately from child records"
    - "Verdict summary clearly states how many children out of N were fully verified"
  artifacts:
    - path: "backend/src/services/fulfillmentVerifier.ts"
      provides: "Multi-child grouping and per-child verdict logic"
      exports: ["ChildVerification"]
  key_links:
    - from: "fulfillmentVerifier.ts childVerifications"
      to: "callerIntentClassifier.ts BookingDetails.childNames"
      via: "intent.details.childNames used to validate completeness"
      pattern: "childNames"
---

<objective>
Add multi-child booking verification and per-child verdict rollup to the fulfillment verifier.

Purpose: VERIFY-05 requires that for multi-child bookings, ALL N children have complete records verified, not just the first. This plan adds child-level grouping and completeness checking.

Output: Enhanced fulfillmentVerifier.ts with childVerifications array populated correctly.
</objective>

<execution_context>
@C:\Users\mwoic\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\mwoic\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-fulfillment-verification/02-RESEARCH.md
@.planning/phases/02-fulfillment-verification/02-01-SUMMARY.md

@backend/src/services/fulfillmentVerifier.ts
@backend/src/services/callerIntentClassifier.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement multi-child grouping and per-child verdict</name>
  <files>backend/src/services/fulfillmentVerifier.ts</files>
  <action>
Enhance `verifyFulfillment` in fulfillmentVerifier.ts to build the `childVerifications` array:

1. **Group claimed records by child name:**
   - After all individual record verifications complete, group RecordVerification results by `claimed.claimedData.childName`
   - Records with no childName go into a "responsible_party" group (parent/adult patient)

2. **Build ChildVerification for each child:**
   - For each unique childName, create a ChildVerification object:
     - `childName`: the child's name
     - `patientRecordStatus`: status of the patient-type ClaimedRecord for this child ('pass'|'fail'|'skipped' if no patient record claimed)
     - `appointmentRecordStatus`: status of the appointment-type ClaimedRecord for this child ('pass'|'fail'|'skipped' if no appointment record claimed)
     - `details`: array of RecordVerification objects for this child

3. **Cross-reference with intent's childNames:**
   - If intent has booking details with childNames array (from callerIntentClassifier), check that EVERY child name in the intent has a corresponding ChildVerification
   - For any child in intent.details.childNames that has NO claimed records at all, create a ChildVerification with status 'fail' and empty details -- this catches the case where the tool never even attempted to create records for a child

4. **Compute overall status with multi-child awareness:**
   - 'pass': ALL children have both patient and appointment verified
   - 'partial': SOME children verified, or some records pass but others fail
   - 'fail': NO children have any verified records
   - 'skipped': No booking intent or no children expected

5. **Enhance summary string:**
   - For multi-child: "Verified 2/3 children fully (Jane: pass, Bob: pass, Tim: fail - no appointment record)"
   - For single child: "Verified: patient record pass, appointment pass"
   - For non-booking: "No booking records to verify"

6. **Handle responsible party (parent) separately:**
   - If a 'lookup' observation found the parent GUID, verify that patient exists too
   - Include in records[] but NOT in childVerifications (parent is not a child)
   - Add to summary: "Parent record: verified" or "Parent record: not found"
  </action>
  <verify>
1. npx tsc --noEmit passes
2. For a session with 2-child booking trace: GET /api/trace-analysis/{sessionId}?verify=true returns childVerifications array with 2 entries, each showing patient + appointment status
3. For a session with missing child records: childVerifications shows 'fail' for the missing child
  </verify>
  <done>
- childVerifications array correctly groups by child name
- Missing children from intent are flagged as 'fail'
- Overall status reflects multi-child completeness (not just first child)
- Summary string clearly states N/M children verified
- Parent/responsible party verified separately
  </done>
</task>

<task type="auto">
  <name>Task 2: Smoke test with real session data</name>
  <files>backend/src/services/fulfillmentVerifier.ts</files>
  <action>
Run a live verification against a known booking session to validate the full pipeline. Follow these exact steps and stop criteria:

**Step 1: Find a test session**
Query the test-agent database for a recent booking session:
```bash
cd test-agent && node -e "const db=require('better-sqlite3')('./data/test-results.db');const rows=db.prepare(\"SELECT session_id, goal_category FROM goal_test_results WHERE goal_category LIKE '%book%' ORDER BY started_at DESC LIMIT 5\").all();console.log(JSON.stringify(rows,null,2));db.close()"
```
Pick the first session_id that has a booking category.

**Step 2: Call the verification endpoint**
```bash
curl -s http://localhost:3002/api/trace-analysis/{SESSION_ID}?verify=true | node -e "const d=[];process.stdin.on('data',c=>d.push(c));process.stdin.on('end',()=>{const r=JSON.parse(Buffer.concat(d));console.log('overallStatus:',r.verification?.overallStatus);console.log('records count:',r.verification?.records?.length);console.log('summary:',r.verification?.summary);if(r.verification?.records?.[0]){console.log('first record status:',r.verification.records[0].status);console.log('first record cloud9Record present:',!!r.verification.records[0].cloud9Record)}})"
```

**Step 3: Evaluate results against these 3 concrete checks:**

CHECK A - Records extracted: `records.length > 0`. If 0, the observation parsing is wrong. Fix: inspect the actual observation output format by reading one observation from the Langfuse trace response, then update extractClaimedRecords field name patterns to match. Common issue: observation name might be slightly different (e.g., 'chord_dso_patient' vs 'chord_ortho_patient').

CHECK B - Cloud9 responded: At least one record has `cloud9Record !== null`. If all null, the Cloud9Client method names or parameters are wrong. Fix: check the Cloud9Client method signatures in client.ts and adjust the calls in verifyPatientRecord/verifyAppointmentRecord.

CHECK C - No unhandled errors: Server logs (terminal running backend) show no uncaught exceptions or stack traces during the request. If errors appear, fix the specific error (missing await, wrong property access, etc.).

**Stop criteria:** All 3 checks pass. Do NOT iterate more than 3 fix cycles. If after 3 fixes the checks still fail, document what is failing and why in a code comment at the top of fulfillmentVerifier.ts and move on.
  </action>
  <verify>
Run the curl command from Step 2 against the chosen session. Confirm:
1. overallStatus is not 'skipped' (records were found and checked)
2. records array has at least one entry with cloud9Record populated
3. Backend terminal shows no unhandled errors during the request
  </verify>
  <done>Verification pipeline works end-to-end with real Langfuse trace data and real Cloud9 API responses. Any output format variations discovered during testing are handled in the parsing logic. If issues remain after 3 fix cycles, they are documented in code comments.</done>
</task>

</tasks>

<verification>
1. TypeScript compiles cleanly
2. Multi-child booking session returns childVerifications with per-child breakdown
3. Single-child booking session returns childVerifications with 1 entry
4. Non-booking session returns overallStatus 'skipped'
5. Missing child (in intent but not in trace) shows as 'fail' in childVerifications
6. Summary string is human-readable and accurate
7. Real session data produces meaningful verification results (not all 'skipped' or all errors)
</verification>

<success_criteria>
- VERIFY-05 satisfied: multi-child bookings verify ALL N children
- VERIFY-02 satisfied: adult + child patient + appointment verified per child
- VERIFY-04 satisfied: clear pass/fail/partial verdict with specific gap details
- Works with real production trace data
</success_criteria>

<output>
After completion, create `.planning/phases/02-fulfillment-verification/02-02-SUMMARY.md`
</output>
