---
phase: 02-fulfillment-verification
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - backend/src/services/fulfillmentVerifier.ts
autonomous: true

must_haves:
  truths:
    - "For multi-child bookings, system groups claimed records by child name and verifies each child independently"
    - "Each child shows individual pass/fail for patient record AND appointment record"
    - "Overall verdict is 'partial' if some children verified but not all"
    - "Responsible party (parent) patient record is verified separately from child records"
    - "Verdict summary clearly states how many children out of N were fully verified"
  artifacts:
    - path: "backend/src/services/fulfillmentVerifier.ts"
      provides: "Multi-child grouping and per-child verdict logic"
      exports: ["ChildVerification"]
  key_links:
    - from: "fulfillmentVerifier.ts childVerifications"
      to: "callerIntentClassifier.ts BookingDetails.childNames"
      via: "intent.details.childNames used to validate completeness"
      pattern: "childNames"
---

<objective>
Add multi-child booking verification and per-child verdict rollup to the fulfillment verifier.

Purpose: VERIFY-05 requires that for multi-child bookings, ALL N children have complete records verified, not just the first. This plan adds child-level grouping and completeness checking.

Output: Enhanced fulfillmentVerifier.ts with childVerifications array populated correctly.
</objective>

<execution_context>
@C:\Users\mwoic\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\mwoic\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-fulfillment-verification/02-RESEARCH.md
@.planning/phases/02-fulfillment-verification/02-01-SUMMARY.md

@backend/src/services/fulfillmentVerifier.ts
@backend/src/services/callerIntentClassifier.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement multi-child grouping and per-child verdict</name>
  <files>backend/src/services/fulfillmentVerifier.ts</files>
  <action>
Enhance `verifyFulfillment` in fulfillmentVerifier.ts to build the `childVerifications` array:

1. **Group claimed records by child name:**
   - After all individual record verifications complete, group RecordVerification results by `claimed.claimedData.childName`
   - Records with no childName go into a "responsible_party" group (parent/adult patient)

2. **Build ChildVerification for each child:**
   - For each unique childName, create a ChildVerification object:
     - `childName`: the child's name
     - `patientRecordStatus`: status of the patient-type ClaimedRecord for this child ('pass'|'fail'|'skipped' if no patient record claimed)
     - `appointmentRecordStatus`: status of the appointment-type ClaimedRecord for this child ('pass'|'fail'|'skipped' if no appointment record claimed)
     - `details`: array of RecordVerification objects for this child

3. **Cross-reference with intent's childNames:**
   - If intent has booking details with childNames array (from callerIntentClassifier), check that EVERY child name in the intent has a corresponding ChildVerification
   - For any child in intent.details.childNames that has NO claimed records at all, create a ChildVerification with status 'fail' and empty details -- this catches the case where the tool never even attempted to create records for a child

4. **Compute overall status with multi-child awareness:**
   - 'pass': ALL children have both patient and appointment verified
   - 'partial': SOME children verified, or some records pass but others fail
   - 'fail': NO children have any verified records
   - 'skipped': No booking intent or no children expected

5. **Enhance summary string:**
   - For multi-child: "Verified 2/3 children fully (Jane: pass, Bob: pass, Tim: fail - no appointment record)"
   - For single child: "Verified: patient record pass, appointment pass"
   - For non-booking: "No booking records to verify"

6. **Handle responsible party (parent) separately:**
   - If a 'lookup' observation found the parent GUID, verify that patient exists too
   - Include in records[] but NOT in childVerifications (parent is not a child)
   - Add to summary: "Parent record: verified" or "Parent record: not found"
  </action>
  <verify>
1. npx tsc --noEmit passes
2. For a session with 2-child booking trace: GET /api/trace-analysis/{sessionId}?verify=true returns childVerifications array with 2 entries, each showing patient + appointment status
3. For a session with missing child records: childVerifications shows 'fail' for the missing child
  </verify>
  <done>
- childVerifications array correctly groups by child name
- Missing children from intent are flagged as 'fail'
- Overall status reflects multi-child completeness (not just first child)
- Summary string clearly states N/M children verified
- Parent/responsible party verified separately
  </done>
</task>

<task type="auto">
  <name>Task 2: Smoke test with real session data</name>
  <files>backend/src/services/fulfillmentVerifier.ts</files>
  <action>
Run a live verification against a known booking session to validate the full pipeline:

1. Find a real session ID from the test-agent database that had a booking intent:
   ```sql
   SELECT session_id FROM goal_test_results WHERE goal_category LIKE '%book%' ORDER BY started_at DESC LIMIT 5;
   ```

2. Call the verification endpoint: GET /api/trace-analysis/{sessionId}?verify=true

3. Inspect the response:
   - Does extractClaimedRecords find GUIDs? If not, inspect the actual observation output format and fix the parsing logic
   - Does Cloud9 return records for the GUIDs? If not, check production vs sandbox environment
   - Do names match? If field paths are wrong, adjust the defensive parsing

4. Fix any issues found during the smoke test. Common fixes:
   - Output field name variations (the research warns about this)
   - Cloud9Client method signature differences
   - Missing await on async calls

This task is about making it ACTUALLY WORK with real data, not just compile.
  </action>
  <verify>
GET /api/trace-analysis/{realSessionId}?verify=true returns a FulfillmentVerdict with:
- overallStatus is not 'skipped' (records were found and checked)
- records array has at least one entry with a cloud9Record populated
- No unhandled errors in server logs
  </verify>
  <done>Verification pipeline works end-to-end with real Langfuse trace data and real Cloud9 API responses. Any output format variations discovered during testing are handled in the parsing logic.</done>
</task>

</tasks>

<verification>
1. TypeScript compiles cleanly
2. Multi-child booking session returns childVerifications with per-child breakdown
3. Single-child booking session returns childVerifications with 1 entry
4. Non-booking session returns overallStatus 'skipped'
5. Missing child (in intent but not in trace) shows as 'fail' in childVerifications
6. Summary string is human-readable and accurate
7. Real session data produces meaningful verification results (not all 'skipped' or all errors)
</verification>

<success_criteria>
- VERIFY-05 satisfied: multi-child bookings verify ALL N children
- VERIFY-02 satisfied: adult + child patient + appointment verified per child
- VERIFY-04 satisfied: clear pass/fail/partial verdict with specific gap details
- Works with real production trace data
</success_criteria>

<output>
After completion, create `.planning/phases/02-fulfillment-verification/02-02-SUMMARY.md`
</output>
