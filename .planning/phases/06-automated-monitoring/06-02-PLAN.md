---
phase: 06-automated-monitoring
plan: 02
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - backend/src/routes/traceAnalysis.ts
  - backend/src/controllers/traceAnalysisController.ts
  - frontend/src/services/api/testMonitorApi.ts
  - frontend/src/pages/TestMonitor/CallTracePage.tsx
autonomous: true

must_haves:
  truths:
    - "User can filter traces by date range"
    - "User can filter traces by pass/fail/partial status from monitoring_results"
    - "User can filter traces by intent type (booking, cancellation, info_lookup, etc.)"
    - "User can search by session ID"
    - "Monitoring status badge shows on each session row"
  artifacts:
    - path: "backend/src/controllers/traceAnalysisController.ts"
      provides: "GET /monitoring-results endpoint with date, status, intent, sessionId filters"
      exports: ["getMonitoringResults"]
    - path: "backend/src/routes/traceAnalysis.ts"
      provides: "Route wiring for monitoring-results endpoint"
    - path: "frontend/src/pages/TestMonitor/CallTracePage.tsx"
      provides: "Filter bar with date, status, intent, search inputs + monitoring badges on sessions"
  key_links:
    - from: "frontend/src/pages/TestMonitor/CallTracePage.tsx"
      to: "frontend/src/services/api/testMonitorApi.ts"
      via: "getMonitoringResults() API call"
      pattern: "getMonitoringResults"
    - from: "frontend/src/services/api/testMonitorApi.ts"
      to: "backend/src/routes/traceAnalysis.ts"
      via: "GET /api/trace-analysis/monitoring-results"
      pattern: "monitoring-results"
    - from: "backend/src/controllers/traceAnalysisController.ts"
      to: "monitoring_results table"
      via: "SQL query with filters"
      pattern: "monitoring_results.*WHERE"
---

<objective>
Add a monitoring results API endpoint with filtering, and integrate filtering UI into the Call Trace page so users can find sessions by date, pass/fail status, intent type, and session ID search.

Purpose: MON-03 (filter traces by date, pass/fail, intent type, session ID search).
Output: Backend filter endpoint + frontend filter bar with monitoring status badges.
</objective>

<execution_context>
@C:\Users\mwoic\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\mwoic\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-automated-monitoring/06-01-SUMMARY.md
@backend/src/controllers/traceAnalysisController.ts
@backend/src/routes/traceAnalysis.ts
@frontend/src/pages/TestMonitor/CallTracePage.tsx
@frontend/src/services/api/testMonitorApi.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add monitoring results API endpoint with filters</name>
  <files>backend/src/controllers/traceAnalysisController.ts, backend/src/routes/traceAnalysis.ts</files>
  <action>
1. **In traceAnalysisController.ts**, add `getMonitoringResults` handler:
   - GET endpoint accepting query params: `dateFrom`, `dateTo`, `status` (pass|fail|partial|error|skipped), `intentType`, `sessionId` (partial match), `limit` (default 50), `offset` (default 0)
   - Query monitoring_results table with dynamic WHERE clauses:
     - dateFrom/dateTo filter on analyzed_at
     - status filters on verification_status (comma-separated for multiple)
     - intentType filters on intent_type (comma-separated for multiple)
     - sessionId does LIKE '%value%' match
   - Return: `{ results: MonitoringResult[], total: number }` where MonitoringResult includes all monitoring_results columns
   - Also join to session_analysis for any extra cached data (caller_intent_summary) if available

2. **In traceAnalysis.ts routes**, add:
   ```typescript
   router.get('/monitoring-results', traceAnalysisController.getMonitoringResults);
   ```

Export the handler function from the controller.
  </action>
  <verify>
    `cd backend && npx tsc --noEmit` compiles. Route is registered.
  </verify>
  <done>
    GET /api/trace-analysis/monitoring-results returns filtered monitoring results with pagination.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add filter bar and monitoring badges to CallTracePage</name>
  <files>frontend/src/services/api/testMonitorApi.ts, frontend/src/pages/TestMonitor/CallTracePage.tsx</files>
  <action>
1. **In testMonitorApi.ts**, add:
   ```typescript
   export interface MonitoringResult {
     id: number;
     session_id: string;
     intent_type: string | null;
     intent_confidence: number | null;
     verification_status: string; // pass, fail, partial, error, skipped
     verdict_summary: string | null;
     diagnostic_status: string | null;
     analyzed_at: string;
   }

   export interface MonitoringFilters {
     dateFrom?: string;
     dateTo?: string;
     status?: string;
     intentType?: string;
     sessionId?: string;
     limit?: number;
     offset?: number;
   }

   export async function getMonitoringResults(filters: MonitoringFilters): Promise<{ results: MonitoringResult[]; total: number }> {
     const params = new URLSearchParams();
     if (filters.dateFrom) params.set('dateFrom', filters.dateFrom);
     if (filters.dateTo) params.set('dateTo', filters.dateTo);
     if (filters.status) params.set('status', filters.status);
     if (filters.intentType) params.set('intentType', filters.intentType);
     if (filters.sessionId) params.set('sessionId', filters.sessionId);
     if (filters.limit) params.set('limit', String(filters.limit));
     if (filters.offset) params.set('offset', String(filters.offset));
     const res = await fetch(`/api/trace-analysis/monitoring-results?${params}`);
     if (!res.ok) throw new Error(`Failed: ${res.status}`);
     return res.json();
   }
   ```

2. **In CallTracePage.tsx**, add a filter/monitoring section above or alongside the existing session list:
   - Add a collapsible "Monitoring Filters" bar at the top with:
     - Date range inputs (dateFrom, dateTo) as date pickers (type="date")
     - Status multi-select buttons (All, Pass, Fail, Partial, Skipped) -- toggle style like existing UI patterns
     - Intent type dropdown (booking, cancellation, rescheduling, info_lookup, other)
     - Session ID search input (text field with debounced search, 300ms)
   - When filters are active, fetch from getMonitoringResults() and display results in a table/list:
     - Columns: Session ID (truncated, clickable to navigate to trace), Intent Type, Status (color-coded badge: green=pass, red=fail, yellow=partial, gray=skipped), Confidence, Analyzed At
     - Status badges: use Tailwind classes -- `bg-green-100 text-green-800` for pass, `bg-red-100 text-red-800` for fail, `bg-yellow-100 text-yellow-800` for partial, `bg-gray-100 text-gray-800` for skipped/error
     - Clicking a session ID should set the search params to load that session in the existing trace viewer
   - Show total count and basic pagination (Next/Previous buttons)
   - Default state: show latest 50 monitoring results with no filters applied
   - Style consistently with existing Tailwind patterns in the page (Card components, text-sm, etc.)
  </action>
  <verify>
    `cd frontend && npx tsc --noEmit` compiles. Filter bar renders. API call returns results.
  </verify>
  <done>
    CallTracePage has a monitoring filter bar with date, status, intent type, and session ID search. Results show color-coded status badges. Clicking a session navigates to its trace view.
  </done>
</task>

</tasks>

<verification>
1. `cd backend && npx tsc --noEmit` -- backend compiles
2. `cd frontend && npx tsc --noEmit` -- frontend compiles
3. GET /api/trace-analysis/monitoring-results?status=fail returns only failed sessions
4. GET /api/trace-analysis/monitoring-results?intentType=booking returns only booking sessions
5. GET /api/trace-analysis/monitoring-results?sessionId=abc123 does partial match
6. CallTracePage filter bar renders and fetches results on filter change
</verification>

<success_criteria>
- Backend endpoint supports date, status, intentType, sessionId filtering with pagination
- Frontend shows filter bar with all 4 filter types
- Session rows display color-coded pass/fail/partial badges
- Session ID click navigates to trace detail view
- All TypeScript compiles cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/06-automated-monitoring/06-02-SUMMARY.md`
</output>
