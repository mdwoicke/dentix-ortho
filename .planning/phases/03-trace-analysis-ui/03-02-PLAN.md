---
phase: 03-trace-analysis-ui
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - frontend/src/pages/TestMonitor/TraceAnalysisPage.tsx
  - frontend/src/services/api/testMonitorApi.ts
autonomous: true

must_haves:
  truths:
    - "User can see fulfillment verdict with pass/fail status and per-check details"
    - "User can see diagnostic report (root cause, affected artifact, proposed diff) when available"
    - "User can click 'Verify Fulfillment' to trigger verification on a loaded trace"
    - "User can click 'Diagnose & Generate Fixes' to trigger diagnosis on a loaded trace"
  artifacts:
    - path: "frontend/src/pages/TestMonitor/TraceAnalysisPage.tsx"
      provides: "Verdict section, diagnostic report section, action buttons"
      min_lines: 350
  key_links:
    - from: "frontend/src/pages/TestMonitor/TraceAnalysisPage.tsx"
      to: "/api/trace-analysis/:sessionId?verify=true"
      via: "getTraceAnalysis with verify option"
      pattern: "verify.*true"
    - from: "frontend/src/pages/TestMonitor/TraceAnalysisPage.tsx"
      to: "/api/test-monitor/production-calls/:traceId/diagnose"
      via: "diagnose API call"
      pattern: "diagnose"
---

<objective>
Add fulfillment verdict display, diagnostic report view, and manual trigger buttons (Verify Fulfillment, Diagnose & Generate Fixes) to the Trace Analysis page.

Purpose: Complete requirements UI-02 (verdict), UI-03 (diagnostic report), UI-04 (manual triggers).
Output: Fully functional Trace Analysis page with all investigation capabilities.
</objective>

<execution_context>
@C:\Users\mwoic\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\mwoic\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-trace-analysis-ui/03-RESEARCH.md
@.planning/phases/03-trace-analysis-ui/03-01-SUMMARY.md
@frontend/src/pages/TestMonitor/TraceAnalysisPage.tsx
@frontend/src/services/api/testMonitorApi.ts
@frontend/src/pages/TestMonitor/AnalysisPage.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add diagnose API function and DiagnosisResult type</name>
  <files>frontend/src/services/api/testMonitorApi.ts</files>
  <action>
Check if `diagnoseProductionTrace` or similar function already exists in testMonitorApi.ts (AnalysisPage uses it). If it exists, reuse it. If not, add:

```typescript
export interface DiagnosisResult {
  rootCause: string;
  affectedArtifact: string;
  confidence: string;
  proposedFix?: string;
  diff?: string;
}

export async function diagnoseTrace(traceId: string): Promise<DiagnosisResult> {
  const response = await post<TestMonitorApiResponse<DiagnosisResult>>(
    `/production-calls/${traceId}/diagnose`, {}
  );
  return response.data;
}
```

Adjust the types and endpoint path based on what actually exists in AnalysisPage.tsx -- the existing diagnose pattern is the source of truth.
  </action>
  <verify>`cd frontend && npx tsc --noEmit 2>&1 | head -20`</verify>
  <done>Diagnose API function available for use by TraceAnalysisPage</done>
</task>

<task type="auto">
  <name>Task 2: Add verdict display, diagnostic report, and action buttons</name>
  <files>frontend/src/pages/TestMonitor/TraceAnalysisPage.tsx</files>
  <action>
Extend TraceAnalysisPage with three additions:

1. **Fulfillment Verdict section (after Tool Sequence card):**
   - Card showing verification.status as large colored badge: fulfilled=green, partially_fulfilled=yellow, not_fulfilled=red, error=gray
   - Checklist of verification.checks: each with name, pass/fail icon, details text
   - Show "Not verified yet" if verification is undefined
   - Show verifiedAt timestamp

2. **Diagnostic Report section (after Verdict card):**
   - Only shown when diagnosis data exists (add `diagnosis` state)
   - Card with: rootCause (text block), affectedArtifact (badge/label), confidence level
   - proposedFix displayed as text
   - diff displayed in `<pre className="bg-gray-900 text-green-400 p-4 rounded text-sm overflow-x-auto">` code block
   - Show "No diagnosis available" placeholder when empty

3. **Action buttons (bottom of page, after all sections):**
   - "Verify Fulfillment" button: calls `getTraceAnalysis(sessionId, { verify: true })`, updates result state with verification data. Show loading spinner on button while running. Disabled if no trace loaded.
   - "Diagnose & Generate Fixes" button: needs a traceId (use first trace from result.traces[0].traceId). Calls diagnose function, stores result in `diagnosis` state. Show loading spinner. Disabled if no trace loaded.
   - "Force Re-analyze" button: calls `getTraceAnalysis(sessionId, { force: true })`, refreshes all data. Useful when backend cache is stale.
   - Buttons in a flex row with gap-3, using Button component or styled buttons matching existing page patterns.

Handle loading states per-action (verifyLoading, diagnoseLoading separate from main loading). Handle errors with inline error messages below buttons.
  </action>
  <verify>
1. `cd frontend && npx tsc --noEmit 2>&1 | head -20` -- compiles
2. `cd frontend && npm run build 2>&1 | tail -5` -- builds
  </verify>
  <done>
Trace Analysis page shows fulfillment verdict with colored status badge and per-check details. Diagnostic report renders root cause, artifact, and diff when available. Three action buttons work: Verify Fulfillment, Diagnose & Generate Fixes, Force Re-analyze. Loading states and error handling work for each button independently.
  </done>
</task>

</tasks>

<verification>
1. Frontend compiles and builds
2. Load a trace with verification data -- verdict card shows status and checks
3. Click "Verify Fulfillment" -- triggers verification, verdict section updates
4. Click "Diagnose & Generate Fixes" -- diagnosis section appears with root cause and diff
5. Click "Force Re-analyze" -- refreshes all data
6. Load a trace without verification -- shows "Not verified yet" with Verify button available
</verification>

<success_criteria>
- Fulfillment verdict displayed with status badge and per-check details
- Diagnostic report shows root cause, affected artifact, and proposed diff
- Manual trigger buttons work for verify, diagnose, and force re-analyze
- All loading/error states handled gracefully
</success_criteria>

<output>
After completion, create `.planning/phases/03-trace-analysis-ui/03-02-SUMMARY.md`
</output>
