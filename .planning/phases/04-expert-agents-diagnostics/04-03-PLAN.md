---
phase: 04-expert-agents-diagnostics
plan: 03
type: execute
wave: 3
depends_on: ["04-02"]
files_modified:
  - backend/src/services/expertAgentService.ts
  - backend/src/services/diagnosticOrchestrator.ts
  - backend/src/services/promptService.ts
  - backend/src/services/noderedDeployService.ts
autonomous: true

must_haves:
  truths:
    - "Diagnostic reports include unified diff of suggested changes against current artifact"
    - "Deploy events are recorded when artifacts are updated or deployed"
    - "Failures can be correlated with the artifact version that was active at failure time"
  artifacts:
    - path: "backend/src/services/expertAgentService.ts"
      provides: "Diff generation added to analysis results"
      contains: "createTwoFilesPatch"
    - path: "backend/src/services/promptService.ts"
      provides: "Deploy event recording on version changes"
      contains: "artifact_deploy_events"
    - path: "backend/src/services/noderedDeployService.ts"
      provides: "Deploy event recording on Node-RED deploys"
      contains: "artifact_deploy_events"
  key_links:
    - from: "backend/src/services/expertAgentService.ts"
      to: "diff library"
      via: "createTwoFilesPatch for unified diffs"
      pattern: "createTwoFilesPatch"
    - from: "backend/src/services/promptService.ts"
      to: "artifact_deploy_events table"
      via: "INSERT on version save"
      pattern: "artifact_deploy_events"
---

<objective>
Add PR-ready unified diffs to diagnostic output and wire deploy event tracking for version correlation.

Purpose: Diffs make fix proposals actionable (copy-paste into PR). Deploy tracking enables "this broke after version X" analysis.
Output: Diffs in expert analysis results, deploy events recorded on version/deploy changes.
</objective>

<execution_context>
@C:\Users\mwoic\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\mwoic\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-expert-agents-diagnostics/04-02-SUMMARY.md
@backend/src/services/expertAgentService.ts
@backend/src/services/diagnosticOrchestrator.ts
@backend/src/services/promptService.ts
@backend/src/services/noderedDeployService.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add unified diff generation to expert analysis results</name>
  <files>backend/src/services/expertAgentService.ts, backend/src/services/diagnosticOrchestrator.ts</files>
  <action>
**In expertAgentService.ts:**

1. Add import: `import { createTwoFilesPatch } from 'diff';` (the `diff` package is available as transitive dependency of ts-node; if import fails, install it: `npm install diff @types/diff --save-dev` in backend/)

2. Add `unifiedDiff?: string` field to `ExpertAnalysisResult` type.

3. In the `analyze()` method, after parsing the LLM response, if `suggestedCode` is non-null and non-empty:
   - Load the current artifact content (already loaded earlier in the method)
   - Generate unified diff: `createTwoFilesPatch(fileKey, fileKey, currentArtifact, suggestedCode, 'current', 'proposed')`
   - Set `result.unifiedDiff = diff`
   - If `suggestedCode` is a partial replacement (not the full file), wrap it in a comment noting it's a partial diff

4. Same for `analyzeStandalone()`.

**In diagnosticOrchestrator.ts:**

Update the combined markdown template to include diffs:
```markdown
## {Agent} Analysis (Confidence: {N}%)
{agent.diagnosticMarkdown}

### Proposed Changes
\`\`\`diff
{agent.unifiedDiff || 'No code changes suggested'}
\`\`\`
```
  </action>
  <verify>
Run `npx tsc --noEmit --project backend/tsconfig.json 2>&1 | head -20`.
Grep for createTwoFilesPatch in expertAgentService.ts.
  </verify>
  <done>Expert analysis results include unified diffs when code changes are suggested. Combined markdown report renders diffs in code blocks.</done>
</task>

<task type="auto">
  <name>Task 2: Wire deploy event recording into promptService and noderedDeployService</name>
  <files>backend/src/services/promptService.ts, backend/src/services/noderedDeployService.ts</files>
  <action>
**In promptService.ts:**

1. Find the method that saves/updates prompt versions (the one that writes to `prompt_working_copies` and `prompt_version_history`). After the version is saved successfully, INSERT into `artifact_deploy_events`:
   ```sql
   INSERT INTO artifact_deploy_events (artifact_key, version, deploy_method, description)
   VALUES (?, ?, 'prompt_update', ?)
   ```
   Use the file_key, new version number, and change description. Wrap in try/catch so deploy event failure doesn't break the save operation.

2. Ensure the `artifact_deploy_events` table is auto-created if missing (add CREATE TABLE IF NOT EXISTS at the point where other tables are auto-created, or rely on schema.sql from Plan 01).

**In noderedDeployService.ts:**

1. Find the deploy method (the one that POSTs flows to Node-RED). After a successful deploy, INSERT into `artifact_deploy_events`:
   ```sql
   INSERT INTO artifact_deploy_events (artifact_key, version, deploy_method, nodered_rev, description)
   VALUES ('nodered_flow', ?, 'nodered_deploy', ?, ?)
   ```
   Get version from prompt_working_copies for nodered_flow. Get nodered_rev from the deploy response. Wrap in try/catch.

2. Import BetterSqlite3 and the database helper if not already imported. Use the same db pattern as other services (getTestAgentDbWritable or similar).
  </action>
  <verify>
Run `npx tsc --noEmit --project backend/tsconfig.json 2>&1 | head -20`.
Grep for artifact_deploy_events in both files.
  </verify>
  <done>Deploy events recorded on every prompt version update and Node-RED deploy. Version correlation queries can now map failure timestamps to active artifact versions.</done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit --project backend/tsconfig.json` passes
- expertAgentService.ts generates unified diffs via createTwoFilesPatch
- promptService.ts records deploy events on version saves
- noderedDeployService.ts records deploy events on Node-RED deploys
- diagnosticOrchestrator combined markdown includes diff code blocks
</verification>

<success_criteria>
Diagnostic reports include PR-ready unified diffs. Deploy events are recorded automatically. Failures can be correlated with artifact versions by timestamp.
</success_criteria>

<output>
After completion, create `.planning/phases/04-expert-agents-diagnostics/04-03-SUMMARY.md`
</output>
