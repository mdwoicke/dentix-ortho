---
phase: 04-expert-agents-diagnostics
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/src/services/expertAgentService.ts
  - backend/src/database/schema.sql
autonomous: true

must_haves:
  truths:
    - "Four expert agents (nodered_flow, patient_tool, scheduling_tool, system_prompt) can be instantiated with domain-specific system prompts"
    - "Each expert agent loads its current V1 artifact from prompt_working_copies table"
    - "Expert agents produce structured JSON analysis with root_cause, affected_artifact, confidence, suggested_code"
    - "artifact_deploy_events table exists for version correlation"
  artifacts:
    - path: "backend/src/services/expertAgentService.ts"
      provides: "Expert agent framework with 4 domain-specific agents"
      exports: ["ExpertAgentService", "ExpertAgentType", "ExpertAnalysisResult"]
      min_lines: 150
  key_links:
    - from: "backend/src/services/expertAgentService.ts"
      to: "shared/services/llm-provider.ts"
      via: "getLLMProvider()"
      pattern: "getLLMProvider"
    - from: "backend/src/services/expertAgentService.ts"
      to: "prompt_working_copies table"
      via: "db.prepare SELECT content FROM prompt_working_copies"
      pattern: "prompt_working_copies"
---

<objective>
Create the expert agent service with four domain-specific LLM agents and the deploy events table for version correlation.

Purpose: Replace the single generic diagnosis prompt with specialized agents that understand each V1 artifact deeply.
Output: expertAgentService.ts with 4 agent types, artifact_deploy_events schema.
</objective>

<execution_context>
@C:\Users\mwoic\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\mwoic\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-expert-agents-diagnostics/04-RESEARCH.md
@backend/src/services/promptService.ts
@shared/services/llm-provider.ts
@backend/src/services/toolSequenceMapper.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create expertAgentService.ts with four domain expert agents</name>
  <files>backend/src/services/expertAgentService.ts</files>
  <action>
Create `backend/src/services/expertAgentService.ts` with:

1. **Types:**
   - `ExpertAgentType = 'nodered_flow' | 'patient_tool' | 'scheduling_tool' | 'system_prompt'`
   - `ExpertAnalysisResult` with fields: agentType, rootCause (type + evidence array), affectedArtifact (fileKey + currentVersion), confidence (0-100), summary, suggestedCode (the replacement code for the affected section), diagnosticMarkdown
   - `ExpertAgentRequest` with fields: agentType, traceContext (transcript text, apiErrors, stepStatuses from toolSequenceMapper), freeformContext? (for standalone invocation)

2. **Domain system prompts** (one per agent type, stored as const strings):
   - `NODERED_FLOW_EXPERT_PROMPT`: Expert in Node-RED flow routing, session cache management, Cloud9 API orchestration, chair selection logic, slot grouping, cache refresh. Understands the flow JSON structure (tabs, nodes, function nodes with JavaScript code). Common failures: wrong chair GUID, stale cache, session ID propagation, rate limiting.
   - `PATIENT_TOOL_EXPERT_PROMPT`: Expert in patient lookup, creation, family linkage, sibling handling, responsible party matching. Understands the chord_ortho_patient tool JavaScript. Common failures: duplicate patient creation, missing family linkage, name matching failures, GUID case sensitivity.
   - `SCHEDULING_TOOL_EXPERT_PROMPT`: Expert in slot search tiers, booking flow, reservation logic, multi-child scheduling, appointment types. Understands the schedule_appointment_ortho tool JavaScript. Common failures: no slots found (tier exhaustion), double-booking, wrong appointment type, slot reservation expiry.
   - `SYSTEM_PROMPT_EXPERT_PROMPT`: Expert in conversation flow design, data gathering sequences, persona rules, edge case handling. Understands the Flowise system prompt markdown. Common failures: skipping required data gathering, wrong tool invocation order, persona violations, ambiguous instructions.

3. **Core class `ExpertAgentService`:**
   - Constructor takes a BetterSqlite3.Database instance (for prompt_working_copies access)
   - `loadArtifact(agentType: ExpertAgentType): string` - Maps agent type to file_key and queries `prompt_working_copies` for current content. For nodered_flow, truncate to first 15000 chars to stay within context limits (add a note about truncation).
   - `analyze(request: ExpertAgentRequest): Promise<ExpertAnalysisResult>` - Loads the relevant artifact, builds the LLM prompt combining domain system prompt + artifact content + trace context, calls `getLLMProvider().execute()` with temperature 0.2, maxTokens 4000, purpose 'failure-analysis'. Parses JSON response into ExpertAnalysisResult. Handle parse failures gracefully (return result with confidence 0 and error in summary).
   - `analyzeStandalone(agentType: ExpertAgentType, context: string): Promise<ExpertAnalysisResult>` - For DIAG-05, accepts freeform context string instead of structured trace data.

4. **File key mapping:**
   - nodered_flow -> 'nodered_flow'
   - patient_tool -> 'patient_tool'
   - scheduling_tool -> 'scheduling_tool'
   - system_prompt -> 'system_prompt'

5. **LLM prompt template** (used in analyze method):
   Build the user prompt as:
   ```
   ## Current Artifact (${fileKey})
   ${artifactContent}

   ## Trace Context
   ### Transcript
   ${request.traceContext.transcript}

   ### API Errors
   ${request.traceContext.apiErrors || 'None'}

   ### Tool Sequence Step Statuses
   ${JSON.stringify(request.traceContext.stepStatuses, null, 2)}

   ## Instructions
   Analyze this failure and produce a JSON response:
   {
     "rootCause": { "type": "...", "evidence": ["..."] },
     "confidence": 0-100,
     "summary": "...",
     "suggestedCode": "replacement code for the affected section, or null if no code change needed",
     "diagnosticMarkdown": "## Root Cause\n..."
   }
   ```

Use the standard `getLLMProvider()` pattern. Import from `'../../../shared/services/llm-provider'`.
  </action>
  <verify>
Run `npx tsc --noEmit --project backend/tsconfig.json 2>&1 | head -20` to verify no type errors.
Verify the file exports ExpertAgentService, ExpertAgentType, ExpertAnalysisResult.
  </verify>
  <done>expertAgentService.ts compiles, exports the service class with 4 agent types, loads artifacts from DB, calls LLM with domain-specific prompts.</done>
</task>

<task type="auto">
  <name>Task 2: Add artifact_deploy_events table to schema</name>
  <files>backend/src/database/schema.sql</files>
  <action>
Add to the end of `backend/src/database/schema.sql`:

```sql
CREATE TABLE IF NOT EXISTS artifact_deploy_events (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  artifact_key TEXT NOT NULL,
  version INTEGER NOT NULL,
  deployed_at TEXT NOT NULL DEFAULT (datetime('now')),
  deploy_method TEXT,
  nodered_rev TEXT,
  description TEXT,
  created_at TEXT NOT NULL DEFAULT (datetime('now'))
);

CREATE INDEX IF NOT EXISTS idx_artifact_deploy_artifact ON artifact_deploy_events(artifact_key);
CREATE INDEX IF NOT EXISTS idx_artifact_deploy_time ON artifact_deploy_events(deployed_at);
```

This supports DIAG-04 (correlate failures with deploy versions). The table records when each artifact version was deployed, enabling queries like "which version was active when this failure occurred?"
  </action>
  <verify>Check schema.sql has the new table definition with `grep artifact_deploy_events backend/src/database/schema.sql`.</verify>
  <done>artifact_deploy_events table defined in schema with indexes on artifact_key and deployed_at.</done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit --project backend/tsconfig.json` passes
- expertAgentService.ts exists and exports ExpertAgentService, ExpertAgentType, ExpertAnalysisResult
- schema.sql contains artifact_deploy_events table
</verification>

<success_criteria>
Four expert agent types defined with domain-specific system prompts. Service loads artifacts from prompt_working_copies and invokes LLM. Deploy events table ready for version correlation.
</success_criteria>

<output>
After completion, create `.planning/phases/04-expert-agents-diagnostics/04-01-SUMMARY.md`
</output>
