---
phase: 01-trace-foundation
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/src/database/schema.sql
  - backend/src/services/langfuseTraceService.ts
autonomous: true

must_haves:
  truths:
    - "Session analysis results (intent, tool sequence) can be cached in the database"
    - "Existing trace retrieval and session grouping work correctly via existing services"
  artifacts:
    - path: "backend/src/database/schema.sql"
      provides: "session_analysis table for caching analysis results"
      contains: "CREATE TABLE IF NOT EXISTS session_analysis"
  key_links:
    - from: "session_analysis table"
      to: "production_sessions table"
      via: "session_id foreign key"
      pattern: "session_id"
---

<objective>
Add the session_analysis database table for caching intent classification and tool sequence results, and verify existing trace/session infrastructure is solid.

Purpose: The orchestration endpoint (Plan 03) needs a place to cache analysis results so re-analysis isn't required on every page load. This plan also confirms existing services (trace import, transcript extraction, session grouping) work as expected.

Output: New `session_analysis` table in schema.sql, verified existing infrastructure.
</objective>

<execution_context>
@C:\Users\mwoic\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\mwoic\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-trace-foundation/01-RESEARCH.md
@backend/src/database/schema.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add session_analysis table to schema</name>
  <files>backend/src/database/schema.sql</files>
  <action>
Add to the END of `backend/src/database/schema.sql` (do NOT modify existing tables):

```sql
-- Session analysis cache (Phase 1: Trace Foundation)
CREATE TABLE IF NOT EXISTS session_analysis (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  session_id TEXT NOT NULL,
  caller_intent_type TEXT, -- booking, rescheduling, cancellation, info_lookup
  caller_intent_confidence REAL,
  caller_intent_summary TEXT,
  booking_details_json TEXT, -- JSON: {childCount, childNames, parentName, parentPhone, requestedDates}
  tool_sequence_json TEXT, -- JSON: ToolSequenceResult from toolSequenceMapper
  completion_rate REAL, -- 0-1
  analyzed_at TEXT NOT NULL DEFAULT (datetime('now')),
  created_at TEXT NOT NULL DEFAULT (datetime('now')),
  UNIQUE(session_id)
);

CREATE INDEX IF NOT EXISTS idx_session_analysis_session ON session_analysis(session_id);
CREATE INDEX IF NOT EXISTS idx_session_analysis_intent ON session_analysis(caller_intent_type);
```

Then ensure the table is created in the running database. Check how other tables are initialized -- likely the backend runs schema.sql on startup, or there's a migration script. If the backend auto-runs schema.sql, just adding to the file is sufficient. If not, also run the CREATE TABLE statement against the database directly.

Look at how the backend initializes the database (search for `schema.sql` usage or `db.exec` calls in the backend startup code).
  </action>
  <verify>
    - The session_analysis table definition is in schema.sql
    - Run the backend (or the schema init) and confirm the table exists: `SELECT name FROM sqlite_master WHERE type='table' AND name='session_analysis';`
  </verify>
  <done>
    - session_analysis table exists in schema.sql and in the running database
    - Table has columns for intent type, confidence, booking details JSON, tool sequence JSON, completion rate
    - Indexed on session_id and caller_intent_type
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify existing trace infrastructure and document API surface</name>
  <files>backend/src/services/langfuseTraceService.ts</files>
  <action>
This is a verification + minor enhancement task. Do NOT rewrite langfuseTraceService.

1. **Read and verify** these existing methods work as documented in research:
   - `importSingleTrace(traceId, configId)` -- imports trace + observations from Langfuse
   - `importSessionTraces(sessionId, configId)` -- imports all traces for a session
   - `getTrace(traceId)` -- retrieves cached trace + observations from local DB
   - `getSession(sessionId)` -- retrieves session with all traces
   - `rebuildSessions()` -- groups traces into sessions by user_id + time proximity

2. **Verify `transformToConversationTurns`** in testMonitorController.ts:
   - Check it returns `{ role: 'user'|'assistant', content: string, timestamp: string }[]`
   - Confirm the ConversationTurn type is exported (or can be imported)

3. **If ConversationTurn type is NOT exported**, add the export. This is needed by callerIntentClassifier.ts (Plan 01).

4. **If `transformToConversationTurns` is only a local function** in testMonitorController (not exported), either:
   - Export it from the controller, OR
   - Extract it to a shared utility (e.g., `backend/src/utils/traceUtils.ts`)

   Prefer the minimal change (just add `export` if possible).

The goal is to ensure Plan 03 can import: ConversationTurn type, transformToConversationTurns, LangfuseTraceService, filterInternalTraces.
  </action>
  <verify>
    - ConversationTurn type is importable from somewhere in backend/src
    - transformToConversationTurns is importable
    - filterInternalTraces is importable
    - `npx tsc --noEmit` passes
  </verify>
  <done>
    - Existing trace infrastructure verified as working
    - ConversationTurn, transformToConversationTurns, and filterInternalTraces are all importable by other backend services
    - No existing functionality broken
  </done>
</task>

</tasks>

<verification>
- schema.sql has session_analysis table
- Table exists in running database
- Core trace functions are importable for use by Plan 03
- `npx tsc --noEmit` passes
</verification>

<success_criteria>
- session_analysis table created and accessible
- Existing trace/session/transcript infrastructure confirmed working and importable
- Zero regressions to existing functionality
</success_criteria>

<output>
After completion, create `.planning/phases/01-trace-foundation/01-02-SUMMARY.md`
</output>
